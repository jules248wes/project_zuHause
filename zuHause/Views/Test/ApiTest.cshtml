@{
    ViewData["Title"] = "API 測試頁面";
}

<div class="container mt-4">
    <h2>zuHause API 測試頁面</h2>
    
    <!-- Data Seeder Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>資料播種控制</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <button id="btnSeedAll" class="btn btn-primary btn-block">建立所有測試資料</button>
                </div>
                <div class="col-md-3">
                    <button id="btnReset" class="btn btn-warning btn-block">重置測試資料</button>
                </div>
                <div class="col-md-3">
                    <button id="btnCreateLandlord" class="btn btn-info btn-block">建立測試房東</button>
                </div>
                <div class="col-md-3">
                    <button id="btnGetStatus" class="btn btn-secondary btn-block">查看資料狀態</button>
                </div>
            </div>
            <div id="seederResult" class="mt-3"></div>
        </div>
    </div>

    <!-- Property Search Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>房源搜尋 API 測試</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label>地區</label>
                    <input type="text" id="searchLocation" class="form-control" placeholder="台北市">
                </div>
                <div class="col-md-2">
                    <label>最低價格</label>
                    <input type="number" id="searchMinPrice" class="form-control" placeholder="10000">
                </div>
                <div class="col-md-2">
                    <label>最高價格</label>
                    <input type="number" id="searchMaxPrice" class="form-control" placeholder="50000">
                </div>
                <div class="col-md-2">
                    <label>房源類型</label>
                    <select id="searchPropertyType" class="form-control">
                        <option value="">全部</option>
                        <option value="套房">套房</option>
                        <option value="雅房">雅房</option>
                        <option value="整層住家">整層住家</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>排序</label>
                    <select id="searchSortBy" class="form-control">
                        <option value="newest">最新</option>
                        <option value="priceasc">價格低到高</option>
                        <option value="pricedesc">價格高到低</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label>&nbsp;</label>
                    <button id="btnSearch" class="btn btn-success btn-block">搜尋</button>
                </div>
            </div>
            <div id="searchResult" class="mt-3"></div>
        </div>
    </div>

    <!-- Property Application Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>房源申請 API 測試</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label>房源 ID</label>
                    <input type="number" id="applicationPropertyId" class="form-control" placeholder="3001">
                </div>
                <div class="col-md-6">
                    <label>申請訊息</label>
                    <input type="text" id="applicationMessage" class="form-control" placeholder="我對這間房源很有興趣">
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button id="btnApply" class="btn btn-primary btn-block">申請房源</button>
                </div>
            </div>
            <div id="applicationResult" class="mt-3"></div>
        </div>
    </div>

    <!-- Image Upload Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>圖片上傳 API 測試</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label>房源 ID</label>
                    <input type="number" id="uploadPropertyId" class="form-control" placeholder="3001">
                </div>
                <div class="col-md-6">
                    <label>選擇圖片</label>
                    <input type="file" id="uploadImages" class="form-control" multiple accept="image/*">
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button id="btnUpload" class="btn btn-info btn-block">上傳圖片</button>
                </div>
            </div>
            <div id="uploadResult" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
// Data Seeder Functions
document.getElementById('btnSeedAll').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/seed/all', { method: 'POST' });
        const result = await response.json();
        displayResult('seederResult', response.ok, result);
    } catch (error) {
        displayResult('seederResult', false, { message: error.message });
    }
});

document.getElementById('btnReset').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/seed/reset', { method: 'POST' });
        const result = await response.json();
        displayResult('seederResult', response.ok, result);
    } catch (error) {
        displayResult('seederResult', false, { message: error.message });
    }
});

document.getElementById('btnCreateLandlord').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/seed/landlord-with-property', { method: 'POST' });
        const result = await response.json();
        displayResult('seederResult', response.ok, result);
    } catch (error) {
        displayResult('seederResult', false, { message: error.message });
    }
});

document.getElementById('btnGetStatus').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/seed/status');
        const result = await response.json();
        displayResult('seederResult', response.ok, result);
    } catch (error) {
        displayResult('seederResult', false, { message: error.message });
    }
});

// Property Search Function
document.getElementById('btnSearch').addEventListener('click', async () => {
    try {
        const params = new URLSearchParams();
        
        const location = document.getElementById('searchLocation').value;
        const minPrice = document.getElementById('searchMinPrice').value;
        const maxPrice = document.getElementById('searchMaxPrice').value;
        const propertyType = document.getElementById('searchPropertyType').value;
        const sortBy = document.getElementById('searchSortBy').value;
        
        if (location) params.append('location', location);
        if (minPrice) params.append('minPrice', minPrice);
        if (maxPrice) params.append('maxPrice', maxPrice);
        if (propertyType) params.append('propertyType', propertyType);
        if (sortBy) params.append('sortBy', sortBy);
        
        const response = await fetch(`/api/properties/search?${params}`);
        const result = await response.json();
        
        if (response.ok) {
            displaySearchResults(result);
        } else {
            displayResult('searchResult', false, result);
        }
    } catch (error) {
        displayResult('searchResult', false, { message: error.message });
    }
});

// Property Application Function
document.getElementById('btnApply').addEventListener('click', async () => {
    try {
        const propertyId = document.getElementById('applicationPropertyId').value;
        const message = document.getElementById('applicationMessage').value;
        
        if (!propertyId) {
            alert('請輸入房源 ID');
            return;
        }
        
        const response = await fetch(`/api/properties/${propertyId}/applications`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });
        
        const result = await response.json();
        displayResult('applicationResult', response.ok, result);
    } catch (error) {
        displayResult('applicationResult', false, { message: error.message });
    }
});

// Image Upload Function
document.getElementById('btnUpload').addEventListener('click', async () => {
    try {
        const propertyId = document.getElementById('uploadPropertyId').value;
        const fileInput = document.getElementById('uploadImages');
        
        if (!propertyId) {
            alert('請輸入房源 ID');
            return;
        }
        
        if (!fileInput.files.length) {
            alert('請選擇圖片檔案');
            return;
        }
        
        const formData = new FormData();
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('images', fileInput.files[i]);
        }
        
        const response = await fetch(`/api/properties/${propertyId}/images`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        displayResult('uploadResult', response.ok, result);
    } catch (error) {
        displayResult('uploadResult', false, { message: error.message });
    }
});

// Helper Functions
function displayResult(elementId, success, data) {
    const element = document.getElementById(elementId);
    const alertClass = success ? 'alert-success' : 'alert-danger';
    element.innerHTML = `
        <div class="alert ${alertClass}">
            <pre>${JSON.stringify(data, null, 2)}</pre>
        </div>
    `;
}

function displaySearchResults(data) {
    const element = document.getElementById('searchResult');
    
    if (data.properties && data.properties.length > 0) {
        let html = `
            <div class="alert alert-success">
                <h6>搜尋結果 (共 ${data.totalCount} 筆，第 ${data.pageNumber}/${data.totalPages} 頁)</h6>
            </div>
            <div class="row">
        `;
        
        data.properties.forEach(property => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${property.title}</h6>
                            <p class="card-text">
                                <strong>位置:</strong> ${property.location}<br>
                                <strong>價格:</strong> $${property.price.toLocaleString()}<br>
                                <strong>類型:</strong> ${property.propertyType}<br>
                                <strong>房間:</strong> ${property.bedrooms || 'N/A'} 房 ${property.bathrooms || 'N/A'} 衛<br>
                                <strong>坪數:</strong> ${property.area || 'N/A'} 坪
                            </p>
                            ${property.isFeatured ? '<span class="badge badge-warning">精選</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        element.innerHTML = html;
    } else {
        element.innerHTML = '<div class="alert alert-info">沒有找到符合條件的房源</div>';
    }
}
</script>