@model zuHause.Models.FurnitureCart
@{
    Layout = "~/Views/Shared/_NavigationBar.cshtml"; // 確保導覽列路徑正確
    ViewBag.Title = "購物車租借清單";

    var rentalEndDate = ViewBag.RentalEndDate as DateOnly?;
    var rentalDaysLeft = ViewBag.RentalDaysLeft as int? ?? 0;
    var propertySelectList = ViewBag.PropertySelectList as SelectList;
    decimal total = 0;
}
<div class="row">
        <!-- 左側功能列 -->
        <div class="col-md-2">
            <h5>會員功能</h5>
            <ul class="list-group">
                <li class="list-group-item">
                    <a href="/Furniture/OrderHistory" class="text-decoration-none">租借 / 購買付款查詢</a>
                </li>
                <li class="list-group-item">
                    <a href="/Furniture/ContactRecords" class="text-decoration-none">聯繫紀錄</a>
                </li>
                <li class="list-group-item active">
                    <a href="/Furniture/RentalCart" class="text-white text-decoration-none">購物車</a>
                </li>
                <li class="list-group-item">
                    <a href="/Member/Logout" class="text-decoration-none">登出</a>
                </li>
            </ul>
        </div>
<!-- 右側內容區 -->
        <div class="col-md-9">

    <div class="col-md-10">
        <h2 class="mt-4">租借清單</h2>

        @if (Model != null && Model.FurnitureCartItems != null && Model.FurnitureCartItems.Any())
        {
            <div class="card p-3 mb-3 shadow-sm">
                <h5 class="card-title mb-3">目前綁定房屋：</h5>
                <div class="mb-3 d-flex align-items-center">
                    <label for="PropertyId" class="form-label me-3 text-nowrap">選擇房源：</label>
                    <select id="PropertyId" name="selectedPropertyId" class="form-select w-auto">
                        <option value="">請選擇房源</option>
                        @if (propertySelectList != null)
                        {
                            foreach (var p in propertySelectList.Items.Cast<SelectListItem>())
                            {
                                @* RZ1031 錯誤修正點：確保 'selected' 屬性的 C# 語法正確 *@
                                <option value="@p.Value" selected="@(p.Selected ? "selected" : null)">
                                    @p.Text
                                </option>
                            }
                        }
                    </select>
                </div>

                <div class="border rounded p-3 bg-light" id="propertyDetailsDisplay">
                    <p class="mb-1"><strong id="strongPropertyId" style="display:none;">房屋編號：</strong> <span id="propertyIdDisplay" style="display:none;"></span></p>
                    <p class="mb-1"><strong id="strongPropertyTitle" style="display:none;">房屋標題：</strong> <span id="propertyTitleDisplay" style="display:none;"></span></p>
                    <p class="mb-1"><strong id="strongEndDate" style="display:none;">到期日：</strong> <span id="endDateDisplay" style="display:none;"></span></p>
                    <p class="mb-0"><strong id="strongDaysLeft" style="display:none;">剩餘可租天數：</strong> <span id="daysLeftDisplay" style="display:none;"></span></p>
                    <p id="noPropertySelected" class="text-muted mb-0">請選擇一個綁定房源以查看詳情。</p>
                </div>
            </div>

            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 28%;">項目</th>
                        <th style="width: 10%;">數量</th>
                        <th style="width: 12%;">原價</th>
                        <th style="width: 12%;">租金/天</th>
                        <th style="width: 10%;">天數</th>
                        <th style="width: 16%;">總租金</th>
                        <th style="width: 12%;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.FurnitureCartItems)
                    {
                        var subTotal = item.RentalDays * item.Product.DailyRental * item.Quantity; // 假設 item.Product 不會是 null
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                    {
                                        <img src="@item.Product.ImageUrl" alt="@item.Product.ProductName" class="me-2 rounded" style="width: 60px; height: 60px; object-fit: cover;" />
                                    }
                                    <span>@item.Product?.ProductName</span>
                                </div>
                            </td>
                            <td>@item.Quantity</td>
                            <td>NT$@item.Product?.ListPrice.ToString("N0")</td>
                            <td>NT$@item.Product?.DailyRental.ToString("N0")</td>
                            <td>@item.RentalDays</td>
                            <td>NT$@subTotal.ToString("N0")</td>
                            <td>
                                <a href="#" class="btn btn-sm btn-outline-secondary me-1">修改</a>
                                <a href="#" class="btn btn-sm btn-outline-danger">刪除</a>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-end">總租金：</td>
                        <td colspan="2"><strong>NT$@totalCartAmount.ToString("N0")</strong></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="text-end">搬運費：</td>
                        <td colspan="2"><strong>NT$@shippingFee.ToString("N0")</strong></td>
                    </tr>
                    <tr class="table-info">
                        <td colspan="5" class="text-end fw-bold">合計金額：</td>
                        <td colspan="2" class="fw-bold text-danger fs-5">NT$@((totalCartAmount + shippingFee).ToString("N0"))</td>
                    </tr>
                </tfoot>
            </table>

            <div class="text-end mt-4">
                <button class="btn btn-success btn-lg me-3">✅ 確定租借</button>
                <a href="/Furniture/FurnitureHomePage" class="btn btn-secondary btn-lg">回到租借首頁</a>
            </div>
        }
        else
        {
            <div class="alert alert-info text-center py-4">
                <p class="lead mb-0">您的購物車目前沒有商品。</p>
                <a href="/Furniture/FurnitureHomePage" class="btn btn-primary mt-3">前往選購家具</a>
            </div>
        }
    </div>
</div>

<input type="hidden" id="propertyInfoJson" value='@Html.Raw(propertyInfoJson)' />
<input type="hidden" id="initialPropertyId" value="@initialPropertyId" />


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const select = document.getElementById("PropertyId");
        const propertyIdDisplay = document.getElementById("propertyIdDisplay");
        const propertyTitleDisplay = document.getElementById("propertyTitleDisplay");
        const endDateDisplay = document.getElementById("endDateDisplay");
        const daysLeftDisplay = document.getElementById("daysLeftDisplay");
        const noPropertySelected = document.getElementById("noPropertySelected");

        const strongPropertyId = document.getElementById("strongPropertyId");
        const strongPropertyTitle = document.getElementById("strongPropertyTitle");
        const strongEndDate = document.getElementById("strongEndDate");
        const strongDaysLeft = document.getElementById("strongDaysLeft");

        const propertyInfoJsonInput = document.getElementById("propertyInfoJson");
        let allPropertiesData = [];

        if (propertyInfoJsonInput && propertyInfoJsonInput.value) {
            try {
                allPropertiesData = JSON.parse(propertyInfoJsonInput.value);
            } catch (e) {
                console.error("解析 propertyInfoJson 失敗:", e);
                allPropertiesData = [];
            }
        }

        // 設置初始選中項
        const initialPropertyIdValue = document.getElementById("initialPropertyId").value;
        if (select) {
            if (initialPropertyIdValue && initialPropertyIdValue !== "0") {
                select.value = initialPropertyIdValue;
            }
            updatePropertyDisplay();
        }

        function updatePropertyDisplay() {
            const selectedId = parseInt(select.value);
            const selectedProperty = allPropertiesData.find(p => p.PropertyId === selectedId);

            if (selectedProperty) {
                propertyIdDisplay.textContent = selectedProperty.PropertyId;
                propertyTitleDisplay.textContent = selectedProperty.Title;
                endDateDisplay.textContent = selectedProperty.ContractEndDate || "無";
                daysLeftDisplay.textContent = selectedProperty.ContractEndDate
                    ? selectedProperty.DaysLeft + " 天"
                    : "無";

                if (propertyIdDisplay) propertyIdDisplay.style.display = 'inline';
                if (propertyTitleDisplay) propertyTitleDisplay.style.display = 'inline';
                if (endDateDisplay) endDateDisplay.style.display = 'inline';
                if (daysLeftDisplay) daysLeftDisplay.style.display = 'inline';

                if (strongPropertyId) strongPropertyId.style.display = 'inline';
                if (strongPropertyTitle) strongPropertyTitle.style.display = 'inline';
                if (strongEndDate) strongEndDate.style.display = 'inline';
                if (strongDaysLeft) strongDaysLeft.style.display = 'inline';

                if (noPropertySelected) noPropertySelected.style.display = 'none';

            } else {
                if (propertyIdDisplay) propertyIdDisplay.textContent = "";
                if (propertyTitleDisplay) propertyTitleDisplay.textContent = "";
                if (endDateDisplay) endDateDisplay.textContent = "";
                if (daysLeftDisplay) daysLeftDisplay.textContent = "";

                if (propertyIdDisplay) propertyIdDisplay.style.display = 'none';
                if (propertyTitleDisplay) propertyTitleDisplay.style.display = 'none';
                if (endDateDisplay) endDateDisplay.style.display = 'none';
                if (daysLeftDisplay) daysLeftDisplay.style.display = 'none';

                if (strongPropertyId) strongPropertyId.style.display = 'none';
                if (strongPropertyTitle) strongPropertyTitle.style.display = 'none';
                if (strongEndDate) strongEndDate.style.display = 'none';
                if (strongDaysLeft) strongDaysLeft.style.display = 'none';

                if (noPropertySelected) noPropertySelected.style.display = 'block';
            }
        }

        if (select) {
            select.addEventListener("change", updatePropertyDisplay);
        }
    });
</script>