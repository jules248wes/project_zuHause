# 用戶端審核提交資料寫入規範

## 概述

當使用者透過用戶端介面提交身分證驗證、房東申請或房源審核時，系統需要在多個資料表中建立相應的記錄。本文件詳細說明各種審核類型的資料寫入規範。

## 共通審核架構

### 核心資料表

1. **`approvals`** - 審核案件主表
2. **`approvalItems`** - 審核操作歷程記錄
3. **`userUploads`** - 使用者上傳檔案記錄（身分證驗證、房源審核）
4. **相關主表** - `members`（身分證/房東）、`properties`（房源）

### 唯一約束機制

- **約束名稱**: `UQ_approvals_member_module (moduleCode, applicantMemberID, sourcePropertyID)`
- **防護機制**: 防止同一會員對同一審核類型的重複申請
- **並行支援**: 允許多個會員同時進行相同類型審核

---

## 1. 身分證驗證審核提交

### 觸發條件
- 使用者在會員介面上傳身分證正反面照片並提交驗證申請

### 資料寫入流程

#### 1.1 approvals 表
```sql
INSERT INTO approvals (
    moduleCode,
    sourcePropertyID,
    applicantMemberID,
    statusCode,
    currentApproverID
) VALUES (
    'IDENTITY',           -- 身分證驗證模組
    NULL,                 -- 審核會員時此欄位為 NULL
    {memberID},           -- 申請會員的ID
    'PENDING',            -- 待審核狀態
    0                     -- 尚未指派審核人員
);
```

#### 1.2 approvalItems 表
```sql
INSERT INTO approvalItems (
    approvalID,
    actionBy,
    actionType,
    actionNote,
    snapshotJSON
) VALUES (
    {approvalID},         -- 上一步建立的審核ID
    NULL,                 -- 使用者提交時為 NULL
    'SUBMIT',             -- 提交申請
    '會員提交身分證驗證申請',
    '{                    -- 會員狀態快照
        "memberID": {memberID},
        "memberName": "{memberName}",
        "submitTime": "{當前時間}",
        "verificationStatus": "pending"
    }'
);
```

#### 1.3 userUploads 表（身分證正面）
```sql
INSERT INTO userUploads (
    memberID,
    approvalID,
    moduleCode,
    uploadTypeCode,
    originalFileName,
    storedFileName,
    filePath,
    fileSize,
    uploadTime
) VALUES (
    {memberID},           -- 上傳會員ID
    {approvalID},         -- 關聯的審核ID
    'MemberInfo',         -- 會員資訊模組
    'USER_ID_FRONT',      -- 身分證正面
    '{原始檔名}',
    '{系統產生檔名}',
    '{檔案儲存路徑}',
    {檔案大小},
    GETDATE()
);
```

#### 1.4 userUploads 表（身分證反面）
```sql
INSERT INTO userUploads (
    memberID,
    approvalID,
    moduleCode,
    uploadTypeCode,
    originalFileName,
    storedFileName,
    filePath,
    fileSize,
    uploadTime
) VALUES (
    {memberID},           -- 上傳會員ID
    {approvalID},         -- 關聯的審核ID
    'MemberInfo',         -- 會員資訊模組
    'USER_ID_BACK',       -- 身分證反面
    '{原始檔名}',
    '{系統產生檔名}',
    '{檔案儲存路徑}',
    {檔案大小},
    GETDATE()
);
```

#### 1.5 members 表狀態保持
- `nationalIdNo` 保持 `NULL`（等待管理員審核後填入）
- `identityVerifiedAt` 保持 `NULL`
- 其他欄位不變

---

## 2. 房東資格審核提交

### 觸發條件
- 已驗證身分證的會員申請成為房東
- 或未驗證身分證的會員直接申請房東（複合申請）→ 可用前端設計避免此狀態被觸發

### 資料寫入流程

#### 2.1 單純房東申請（已驗證身分證）

**approvals 表**:

```sql
INSERT INTO approvals (
    moduleCode,
    sourcePropertyID,
    applicantMemberID,
    statusCode,
    currentApproverID
) VALUES (
    'LANDLORD',           -- 房東資格驗證模組
    NULL,                 -- 審核會員時此欄位為 NULL
    {memberID},           -- 申請會員的ID
    'PENDING',            -- 待審核狀態
    0                     -- 尚未指派審核人員
);
```

**approvalItems 表**:
```sql
INSERT INTO approvalItems (
    approvalID,
    actionBy,
    actionType,
    actionNote,
    snapshotJSON
) VALUES (
    {approvalID},         -- 審核ID
    NULL,                 -- 使用者提交
    'SUBMIT',             -- 提交申請
    '會員提交房東資格申請',
    '{                    -- 會員狀態快照
        "memberID": {memberID},
        "memberName": "{memberName}",
        "currentIsLandlord": false,
        "identityVerified": true,
        "submitTime": "{當前時間}"
    }'
);
```

#### 2.2 複合申請（同時申請身分證和房東）→ 可用前端設計避免此狀態被觸發

**第一筆 - 身分證驗證**:
```sql
-- approvals 表
INSERT INTO approvals (moduleCode, sourcePropertyID, applicantMemberID, statusCode, currentApproverID)
VALUES ('IDENTITY', NULL, {memberID}, 'PENDING', 0);

-- approvalItems 表
INSERT INTO approvalItems (approvalID, actionBy, actionType, actionNote, snapshotJSON)
VALUES ({identityApprovalID}, NULL, 'SUBMIT', '會員提交身分證驗證申請（複合申請）', '{...}');

-- userUploads 表（正反面各一筆）
-- （同身分證驗證流程）
```

**第二筆 - 房東申請**:
```sql
-- approvals 表
INSERT INTO approvals (moduleCode, sourcePropertyID, applicantMemberID, statusCode, currentApproverID)
VALUES ('LANDLORD', NULL, {memberID}, 'PENDING', 0);

-- approvalItems 表
INSERT INTO approvalItems (approvalID, actionBy, actionType, actionNote, snapshotJSON)
VALUES ({landlordApprovalID}, NULL, 'SUBMIT', '會員提交房東資格申請（複合申請）', '{...}');
```

#### 2.3 members 表狀態保持
- `isLandlord` 保持 `false`（等待審核通過後更新為 `true`）
- `memberTypeID` 保持 `1`（等待審核通過後更新為 `2`）
- 其他欄位不變

---

## 3. 房源審核提交

### 觸發條件
- 已驗證的房東填寫房源資訊並上傳證明文件後提交申請

### 前置條件檢查
- 申請人必須是已驗證房東（`members.isLandlord = true`）
- 必須提供房源證明文件

### 資料寫入流程

#### 3.1 properties 表
```sql
INSERT INTO properties (
    landlordMemberID,
    title,
    description,
    cityID,
    districtID,
    addressLine,
    monthlyRent,
    depositAmount,
    depositMonths,
    roomCount,
    livingRoomCount,
    bathroomCount,
    currentFloor,
    totalFloors,
    area,
    minimumRentalMonths,
    specialRules,
    waterFeeType,
    customWaterFee,
    electricityFeeType,
    customElectricityFee,
    managementFeeIncluded,
    managementFeeAmount,
    parkingAvailable,
    parkingFeeRequired,
    parkingFeeAmount,
    cleaningFeeRequired,
    cleaningFeeAmount,
    listingDays,
    listingFeeAmount,
    listingPlanID,
    isPaid,
    propertyProofURL,
    previewImageURL,
    statusCode,
    publishedAt
) VALUES (
    {landlordMemberID},   -- 房東會員ID
    '{房源標題}',
    '{房源描述}',
    {cityID},             -- 城市ID
    {districtID},         -- 區域ID
    '{詳細地址}',
    {monthlyRent},        -- 月租金
    {depositAmount},      -- 押金金額
    {depositMonths},      -- 押金月數
    {roomCount},          -- 房間數
    {livingRoomCount},    -- 客廳數
    {bathroomCount},      -- 浴室數
    {currentFloor},       -- 樓層
    {totalFloors},        -- 總樓層
    {area},               -- 坪數
    {minimumRentalMonths}, -- 最短租期
    '{特殊規定}',
    '{水費類型}',
    {customWaterFee},     -- 自訂水費
    '{電費類型}',
    {customElectricityFee}, -- 自訂電費
    {managementFeeIncluded}, -- 是否包含管理費
    {managementFeeAmount},   -- 管理費金額
    {parkingAvailable},      -- 是否有停車位
    {parkingFeeRequired},    -- 是否需停車費
    {parkingFeeAmount},      -- 停車費金額
    {cleaningFeeRequired},   -- 是否需清潔費
    {cleaningFeeAmount},     -- 清潔費金額
    {listingDays},           -- 刊登天數
    {listingFeeAmount},      -- 刊登費用
    {listingPlanID},         -- 刊登方案ID
    0,                       -- isPaid: 尚未付費
    '{propertyProofURL}',    -- 房源證明文件URL
    '{previewImageURL}',     -- 預覽圖片URL
    'PENDING',               -- statusCode: 待審核
    NULL                     -- publishedAt: 尚未發布
);
```

#### 3.2 approvals 表
```sql
INSERT INTO approvals (
    moduleCode,
    sourcePropertyID,
    applicantMemberID,
    statusCode,
    currentApproverID
) VALUES (
    'PROPERTY',           -- 房源審核模組
    {propertyID},         -- 審核的房源ID
    {landlordMemberID},   -- 申請房東的會員ID
    'PENDING',            -- 待審核狀態
    0                     -- 尚未指派審核人員
);
```

#### 3.3 approvalItems 表
```sql
INSERT INTO approvalItems (
    approvalID,
    actionBy,
    actionType,
    actionNote,
    snapshotJSON
) VALUES (
    {approvalID},         -- 審核ID
    NULL,                 -- 房東提交
    'SUBMIT',             -- 提交申請
    '房東提交房源審核申請',
    '{                    -- 房源狀態快照
        "propertyID": {propertyID},
        "title": "{房源標題}",
        "landlordMemberID": {landlordMemberID},
        "monthlyRent": {monthlyRent},
        "depositAmount": {depositAmount},
        "address": "{完整地址}",
        "area": {area},
        "roomCount": {roomCount},
        "submitTime": "{當前時間}",
        "propertyProofURL": "{propertyProofURL}"
    }'
);
```

#### 3.4 userUploads 表（房源證明文件）
```sql
INSERT INTO userUploads (
    memberID,
    approvalID,
    moduleCode,
    uploadTypeCode,
    originalFileName,
    storedFileName,
    filePath,
    fileSize,
    uploadTime
) VALUES (
    {landlordMemberID},   -- 房東會員ID
    {approvalID},         -- 關聯的審核ID
    'PropertyInfo',       -- 房源資訊模組
    'PROPERTY_PROOF',     -- 房源證明文件（固定值）
    '{原始檔名}',
    '{系統產生檔名}',
    '{檔案儲存路徑}',
    {檔案大小},
    GETDATE()
);
```

---

## 4. 資料一致性與安全性

### 唯一約束驗證

**身分證和房東申請**:
```sql
-- 約束檢查：同一會員不能重複申請同類型審核
UQ_approvals_member_module (moduleCode, applicantMemberID, sourcePropertyID)

-- 身分證申請：('IDENTITY', memberID, NULL)
-- 房東申請：('LANDLORD', memberID, NULL)
```

**房源申請**:
```sql
-- 約束檢查：同一房源只能有一筆審核記錄
UQ_approvals_member_module (moduleCode, applicantMemberID, sourcePropertyID)

-- 房源申請：('PROPERTY', landlordMemberID, propertyID)
```

### 交易完整性

#### 身分證驗證提交事務
```sql
BEGIN TRANSACTION;

-- 1. 建立審核記錄
INSERT INTO approvals (...);
SET @approvalID = SCOPE_IDENTITY();

-- 2. 建立操作歷程
INSERT INTO approvalItems (approvalID, ...) VALUES (@approvalID, ...);

-- 3. 建立檔案上傳記錄（正面）
INSERT INTO userUploads (approvalID, uploadTypeCode, ...) VALUES (@approvalID, 'USER_ID_FRONT', ...);

-- 4. 建立檔案上傳記錄（反面）
INSERT INTO userUploads (approvalID, uploadTypeCode, ...) VALUES (@approvalID, 'USER_ID_BACK', ...);

COMMIT TRANSACTION;
```

#### 房東申請提交事務
```sql
BEGIN TRANSACTION;

-- 1. 建立審核記錄
INSERT INTO approvals (...);
SET @approvalID = SCOPE_IDENTITY();

-- 2. 建立操作歷程
INSERT INTO approvalItems (approvalID, ...) VALUES (@approvalID, ...);

-- 3. 如果是複合申請，重複上述步驟建立身分證審核記錄

COMMIT TRANSACTION;
```

#### 房源申請提交事務
```sql
BEGIN TRANSACTION;

-- 1. 建立房源記錄
INSERT INTO properties (...);
SET @propertyID = SCOPE_IDENTITY();

-- 2. 建立審核記錄
INSERT INTO approvals (sourcePropertyID, ...) VALUES (@propertyID, ...);
SET @approvalID = SCOPE_IDENTITY();

-- 3. 建立操作歷程
INSERT INTO approvalItems (approvalID, ...) VALUES (@approvalID, ...);

-- 4. 建立檔案上傳記錄
INSERT INTO userUploads (approvalID, moduleCode, uploadTypeCode, ...) VALUES (@approvalID, 'PropertyInfo', 'PROPERTY_PROOF', ...);

COMMIT TRANSACTION;
```

### 狀態同步機制

- **觸發器保護**: `trg_approvals_status_sync` 確保審核狀態與主表狀態同步
- **房東身份驗證**: `trg_properties_validate_landlord` 確保只有房東能提交房源
- **狀態保護**: 防止直接修改狀態，必須透過審核流程

---

## 5. 錯誤處理與回滾

### 常見錯誤情況

#### 5.1 唯一約束違反
```sql
-- 錯誤：重複申請
VIOLATION OF UNIQUE KEY constraint 'UQ_approvals_member_module'

-- 處理：檢查現有審核狀態
SELECT statusCode FROM approvals 
WHERE moduleCode = '{moduleCode}' 
  AND applicantMemberID = {memberID}
  AND (sourcePropertyID = {propertyID} OR sourcePropertyID IS NULL)
```

#### 5.2 前置條件不符
```sql
-- 房源申請前檢查房東資格
IF NOT EXISTS (
    SELECT 1 FROM members 
    WHERE memberID = {memberID} 
      AND isLandlord = 1 
      AND identityVerifiedAt IS NOT NULL
)
BEGIN
    RAISERROR('申請人非已驗證房東', 16, 1);
    RETURN;
END
```

#### 5.3 檔案上傳失敗
```sql
-- 如果檔案上傳失敗，回滾整個審核申請
IF @@ERROR <> 0
BEGIN
    ROLLBACK TRANSACTION;
    -- 清理已上傳的檔案
    -- 回傳錯誤訊息
END
```

### 資料回復策略

**部分失敗回復**:
1. 記錄錯誤日誌
2. 回滾資料庫事務
3. 清理已上傳檔案
4. 向使用者提供明確錯誤訊息

**系統故障回復**:
1. 資料庫事務自動回滾
2. 定期清理孤立檔案
3. 審核狀態一致性檢查

---

## 6. 實作範例

### C# 程式碼範例

#### 身分證驗證提交
```csharp
public async Task<int> SubmitIdentityVerification(int memberID, IFormFile frontImage, IFormFile backImage)
{
    using var transaction = await _context.Database.BeginTransactionAsync();
    
    try
    {
        // 1. 建立審核記錄
        var approval = new Approval
        {
            ModuleCode = "IDENTITY",
            SourcePropertyID = null,
            ApplicantMemberID = memberID,
            StatusCode = "PENDING",
            CurrentApproverID = 0
        };
        
        _context.Approvals.Add(approval);
        await _context.SaveChangesAsync();
        
        // 2. 建立操作歷程
        var approvalItem = new ApprovalItem
        {
            ApprovalID = approval.ApprovalID,
            ActionBy = null,
            ActionType = "SUBMIT",
            ActionNote = "會員提交身分證驗證申請",
            SnapshotJSON = JsonSerializer.Serialize(new {
                memberID = memberID,
                submitTime = DateTime.Now
            })
        };
        
        _context.ApprovalItems.Add(approvalItem);
        
        // 3. 處理檔案上傳
        var frontUpload = await ProcessImageUpload(frontImage, memberID, approval.ApprovalID, "USER_ID_FRONT");
        var backUpload = await ProcessImageUpload(backImage, memberID, approval.ApprovalID, "USER_ID_BACK");
        
        _context.UserUploads.AddRange(frontUpload, backUpload);
        
        await _context.SaveChangesAsync();
        await transaction.CommitAsync();
        
        return approval.ApprovalID;
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

#### 房源審核提交
```csharp
public async Task<int> SubmitPropertyReview(PropertySubmissionDto propertyData)
{
    using var transaction = await _context.Database.BeginTransactionAsync();
    
    try
    {
        // 1. 驗證房東資格
        var landlord = await _context.Members
            .FirstOrDefaultAsync(m => m.MemberID == propertyData.LandlordMemberID 
                                   && m.IsLandlord 
                                   && m.IdentityVerifiedAt != null);
        
        if (landlord == null)
            throw new UnauthorizedAccessException("申請人非已驗證房東");
        
        // 2. 建立房源記錄
        var property = new Property
        {
            LandlordMemberID = propertyData.LandlordMemberID,
            Title = propertyData.Title,
            // ... 其他房源資料
            StatusCode = "PENDING",
            PropertyProofURL = propertyData.PropertyProofURL
        };
        
        _context.Properties.Add(property);
        await _context.SaveChangesAsync();
        
        // 3. 建立審核記錄
        var approval = new Approval
        {
            ModuleCode = "PROPERTY",
            SourcePropertyID = property.PropertyID,
            ApplicantMemberID = propertyData.LandlordMemberID,
            StatusCode = "PENDING",
            CurrentApproverID = 0
        };
        
        _context.Approvals.Add(approval);
        await _context.SaveChangesAsync();
        
        // 4. 建立操作歷程
        var approvalItem = new ApprovalItem
        {
            ApprovalID = approval.ApprovalID,
            ActionBy = null,
            ActionType = "SUBMIT",
            ActionNote = "房東提交房源審核申請",
            SnapshotJSON = JsonSerializer.Serialize(new {
                propertyID = property.PropertyID,
                title = property.Title,
                submitTime = DateTime.Now
            })
        };
        
        _context.ApprovalItems.Add(approvalItem);
        
        // 5. 處理房源證明文件上傳
        var propertyProofUpload = await ProcessFileUpload(
            propertyData.ProofFile, 
            propertyData.LandlordMemberID, 
            approval.ApprovalID, 
            "PROPERTY_PROOF"
        );
        
        _context.UserUploads.Add(propertyProofUpload);
        await _context.SaveChangesAsync();
        
        await transaction.CommitAsync();
        return approval.ApprovalID;
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

---

## 7. 總結

### 資料寫入原則

1. **事務完整性**: 所有相關資料必須在同一事務中處理
2. **狀態一致性**: 主表狀態必須與審核狀態保持同步
3. **歷程完整性**: 每個操作都必須有完整的操作歷程記錄
4. **唯一性約束**: 利用資料庫約束防止重複申請
5. **前置條件驗證**: 確保申請人具備相應資格

### 審核類型對應表

| 審核類型 | moduleCode | sourcePropertyID | 主要檔案上傳 | 前置條件 |
|----------|------------|------------------|-------------|----------|
| 身分證驗證 | IDENTITY | NULL | USER_ID_FRONT, USER_ID_BACK | 已註冊會員 |
| 房東申請 | LANDLORD | NULL | 無 | 已驗證身分證 |
| 複合申請 | IDENTITY + LANDLORD | NULL | USER_ID_FRONT, USER_ID_BACK | 已註冊會員 |
| 房源審核 | PROPERTY | propertyID | PROPERTY_PROOF | 已驗證房東 |

###  關鍵資料結構 - approvals 表結構

| 欄位              | 身分證驗證 | 房東申請 | 房源審核         |
| ----------------- | ---------- | -------- | ---------------- |
| moduleCode        | IDENTITY   | LANDLORD | PROPERTY         |
| sourcePropertyID  | NULL       | NULL     | propertyID       |
| applicantMemberID | memberID   | memberID | landlordMemberID |
| statusCode        | PENDING    | PENDING  | PENDING          |

### 關鍵注意事項

- **檔案上傳**: 身分證驗證需要同時上傳正反面，兩筆檔案記錄都必須關聯到同一個 approvalID；房源審核需要上傳一筆證明文件（PROPERTY_PROOF）
- **複合申請**: 未驗證身分證的房東申請會產生兩筆獨立的審核記錄
- **狀態管理**: 提交時主表狀態設為對應的待審核狀態，等待管理員審核
- **快照記錄**: snapshotJSON 記錄提交時的完整狀態，供後續稽核使用

此規範確保了審核系統的資料完整性和可追溯性，為後續的管理員審核和系統維護提供了完整的資料基礎。