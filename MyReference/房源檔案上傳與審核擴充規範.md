# 房源檔案上傳與審核擴充規範

## 1. 概述

為支援房源刊登時，房東能夠上傳多份不同類型的證明文件（如所有權狀、代理授權書、現場照片等），並讓管理員能夠在後台統一審核，本文件旨在擴充現有的 `userUploads` 資料表應用範圍，使其能夠同時管理房源相關的審核檔案。

**核心原則**：重用 `userUploads` 表的通用設計，透過新增 `moduleCode` 與 `uploadTypeCode` 的組合，來區分不同業務場景下的檔案。

---

## 2. 核心設計與 `userUploads` 表擴充應用

為了讓 `userUploads` 表能夠儲存房源審核檔案，我們需要定義新的 `moduleCode` 和一組新的 `uploadTypeCode`。

### 2.1 `moduleCode` 的定義

-   **`MemberInfo`**: 維持不變，專門用於儲存與**會員個人**相關的檔案（如身分證）。
-   **`PropertyInfo` (建議新增)**: 新增此代碼，專門用於儲存與**特定房源**相關的檔案。

### 2.2 `uploadTypeCode` 的定義 (for `PropertyInfo`)

針對 `moduleCode = 'PropertyInfo'`，我們定義以下幾種檔案類型，以應對房源審核的多元需求。此設計具備未來擴充性。

| `uploadTypeCode` | 檔案類型說明 | 業務用途 |
| :--- | :--- | :--- |
| **`PROPERTY_PROOF_OWNERSHIP`** | **所有權證明** | 房源所有權狀、房屋稅單等，證明房東對該房源的所有權。**此為主要審核文件**。 |
| **`PROPERTY_PROOF_DELEGATION`** | **代理授權證明** | 若房東非屋主本人，需上傳屋主簽署的代理或委託授權書。 |
| **`PROPERTY_PHOTO_INTERIOR`** | **內部照片** | 房屋內部實景照片，如客廳、房間、衛浴等，供管理員核對資訊。 |
| **`PROPERTY_PHOTO_EXTERIOR`** | **外部照片** | 房屋建築外觀、門牌等照片，用於確認地址與建物狀況。 |
| **`PROPERTY_PHOTO_OTHER`** | **其他補充文件** | 其他房東認為有助於審核的補充文件或照片。 |

### 2.3 關聯機制

所有為同一次房源審核所上傳的檔案，都會在 `userUploads` 表中透過 `approvalID` 欄位，關聯到 `approvals` 表中該筆 `moduleCode = 'PROPERTY'` 的審核案件。

---

## 3. 資料寫入流程

當一位已驗證的房東提交一筆新的房源審核申請，並上傳了 **N** 筆證明文件時，系統應在**單一資料庫交易**中，執行以下所有操作：

#### 3.1 `properties` 表 (建立 1 筆房源紀錄)
-   寫入一筆新的房源資料，並將 `statusCode` 設為 `'PENDING'`。
-   取得新建立的 `propertyID`。

#### 3.2 `approvals` 表 (建立 1 筆審核案件)
-   寫入一筆新的審核案件紀錄。
    -   `moduleCode`: `'PROPERTY'`
    -   `applicantMemberID`: 房東的會員 ID
    -   `sourcePropertyID`: 上一步取得的 `propertyID`
    -   `statusCode`: `'PENDING'`
-   取得新建立的 `approvalID`。

#### 3.3 `approvalItems` 表 (建立 1 筆操作歷程)
-   寫入一筆初始提交紀錄。
    -   `approvalID`: 上一步取得的 `approvalID`
    -   `actionType`: `'SUBMIT'`
    -   `actionBy`: `NULL`
    -   `snapshotJSON`: 包含房源關鍵資訊的快照。

#### 3.4 `userUploads` 表 (建立 N 筆檔案紀錄)
-   **針對使用者上傳的每一筆檔案，都執行一次 `INSERT` 操作**。

**範例：房東上傳了「所有權狀」和「內部照片」共兩份文件**

**第一筆檔案 (所有權狀):**
```sql
INSERT INTO userUploads (
    memberID,
    approvalID,
    moduleCode,
    uploadTypeCode,
    filePath,
    ...
) VALUES (
    {landlordMemberID},   -- 房東會員ID
    {approvalID},         -- 關聯的審核ID
    'PropertyInfo',       -- 房源資訊模組
    'PROPERTY_PROOF_OWNERSHIP', -- 所有權證明
    '{權狀檔案路徑}',
    ...
);
```

**第二筆檔案 (內部照片):**
```sql
INSERT INTO userUploads (
    memberID,
    approvalID,
    moduleCode,
    uploadTypeCode,
    filePath,
    ...
) VALUES (
    {landlordMemberID},   -- 房東會員ID
    {approvalID},         -- 關聯的審核ID
    'PropertyInfo',       -- 房源資訊模組
    'PROPERTY_PHOTO_INTERIOR', -- 內部照片
    '{照片檔案路徑}',
    ...
);
```

---

## 4. 交易完整性

整個流程——從建立房源、建立審核案件、到寫入所有檔案紀錄——都必須被包裹在一個資料庫交易 (Transaction) 中。若其中任何一個環節失敗（例如，某個檔案寫入失敗），整個交易必須全部回滾 (Rollback)，以確保資料庫不會出現不一致的孤兒資料。

```sql
BEGIN TRANSACTION;

-- 1. 建立房源紀錄
INSERT INTO properties (...);
SET @propertyID = SCOPE_IDENTITY();

-- 2. 建立審核記錄
INSERT INTO approvals (sourcePropertyID, ...) VALUES (@propertyID, ...);
SET @approvalID = SCOPE_IDENTITY();

-- 3. 建立操作歷程
INSERT INTO approvalItems (approvalID, ...) VALUES (@approvalID, ...);

-- 4. 建立第一筆檔案上傳記錄
INSERT INTO userUploads (approvalID, moduleCode, uploadTypeCode, ...) VALUES (@approvalID, 'PropertyInfo', 'PROPERTY_PROOF_OWNERSHIP', ...);

-- 5. 建立第二筆檔案上傳記錄
INSERT INTO userUploads (approvalID, moduleCode, uploadTypeCode, ...) VALUES (@approvalID, 'PropertyInfo', 'PROPERTY_PHOTO_INTERIOR', ...);

-- ... 若有更多檔案，繼續 INSERT ...

-- 6. 若所有操作皆成功
COMMIT TRANSACTION;

-- 若中途發生任何錯誤
-- ROLLBACK TRANSACTION;
```

---

## 5. 後台管理介面設計建議

在管理員審核房源的介面中：
1.  應有一個專門的區塊或分頁，用來展示所有與此房源審核案件相關的檔案。
2.  檔案列表應清楚顯示每個檔案的 `uploadTypeCode`（例如，顯示為「所有權證明」、「內部照片」）、檔案名稱、上傳時間等。
3.  提供點擊預覽功能，讓管理員可以方便地查看圖片內容或下載文件。

---

## 6. 總結：與身分證驗證的比較

| 特性 | 身分證驗證 (`IDENTITY`) | 房源審核 (`PROPERTY`) |
| :--- | :--- | :--- |
| **使用資料表** | `userUploads` | `userUploads` (重用) |
| **`moduleCode`** | `MemberInfo` | `PropertyInfo` |
| **`uploadTypeCode`** | 固定 (`USER_ID_FRONT`, `USER_ID_BACK`) | **可擴充** (`PROPERTY_PROOF_...`, `PROPERTY_PHOTO_...`) |
| **檔案數量** | **固定為 2 筆** | **不固定，可為 1 至多筆** |
| **關聯對象** | `approvals` (其中 `sourcePropertyID` 為 NULL) | `approvals` (其中 `sourcePropertyID` 為房源ID) |

此設計方案確保了系統架構的一致性與可擴充性，能夠穩健地支援房源審核的業務需求。
