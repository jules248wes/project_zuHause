# 資料庫應有以下表：
## 1. 會員資料表 (members)
## 2. 會員身分表 (memberTypes)
## 3. 通訊相關驗證表 (memberVerifications)
## 4. 尋租文章資料表 (renterPosts)
## 5. 尋租文章回覆資料表 (renterPostReplies)
## 6. 尋租文章需求條件清單 (renterRequirementList)
## 7. 尋租條件關聯 (renterRequirementRelations)
## 8. 搜索歷史表 (searchHistory／搜索歷史表)
## 9. 收藏表 (favorites／收藏表)
## 10. 租賃/看房申請資料表 (rentalApplications)
## 11. 申請狀態歷程表 (applicationStatusLogs)
## 12. 房源資料表 (properties)
## 13. 房源圖片表 (propertyImages)
## 14. 房源設備分類資料表 (propertyEquipmentCategories)
## 15. 房源設備關聯資料表 (propertyEquipmentRelations)
## 16. 刊登費方案表 (listingPlans／刊登費表)
## 17. 家具配送費方案表 (deliveryFeePlans／家具配送費表)
## 18. 輪播圖片表 (carouselImages／輪播圖片表)
## 19. 頁面代碼表 (pages／共用頁面代碼表)
## 20. 使用者通知資料表 (userNotifications／使用者通知資料表)
## 21. 系統訊息表 (systemMessages／系統訊息表)
## 22. 後台訊息模板表 (adminMessageTemplates／後台訊息模板表)
## 23. 審核表 (landlordApprovals) / approvals (審核主檔)
## 24. 審核表 (landlordApprovals) / approvalItems (審核明細)
## 25. 家具商品分類表 (furnitureCategories)
## 26. 家具商品資料表 (furnitureProducts)
## 27. 家具庫存表 (furnitureInventory)
## 28. inventoryEvents（庫存事件表）
## 29. 家具購物車表 (furnitureCarts)
## 30. 家具購物車明細表 (furnitureCartItems)
## 31. 家具訂單查詢表 (furnitureOrders)
## 32. 家具訂單查詢明細表 (furnitureOrderItems)
## 33. 訂單事件表 (orderEvents)
## 34. 家具歷史訂單清單 (furnitureOrderHistory)
## 35. 家具租賃合約表 (furnitureRentalContracts)
## 36 網站訊息表 (siteMessages／網站訊息表)
## 37 訊息位置表 (messagePlacements／訊息位置表)
## 38. 會員上傳資料紀錄表 (userUploads／會員上傳資料紀錄表)
## 39. 檔案審核表 (fileApprovals／檔案審核表)
## 40. 客服聯繫表 (customerServiceTickets／客服聯繫表)
## 41. 房源投訴表 (propertyComplaints／房源投訴表)
## 42. contracts 〈合約欄位儲存表〉
## 43. contractFurnitureItems 〈合約內容家具表〉
## 44. contractComments 〈合約備註表〉
## 45. contractSignatures 〈電子簽名儲存表〉
## 46. contractCustomFields 〈合約附表(動態欄位)〉
## 47. contractTemplates 〈合約範本表〉
## 48. 縣市代碼表 (cities／縣市代碼表)
## 49. 鄉鎮區代碼表 (districts／鄉鎮區代碼表)
## 50. 代碼類別表 (systemCodeCategories／代碼類別表)
## 51. 代碼總表 (systemCodes／代碼總表)
## 52. 管理員資料表 (admins／管理員資料表)
## 53. 管理員角色資料表 (adminRoles／管理員角色資料表)
## 54. 聊天室表 (chatrooms)
## 55. 聊天室訊息表 (chatroomMessages)



# 用戶管理模組

## 1. 會員資料表 (members)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 舊欄位來源／說明 |
|---|---|---|---|---|
| 1 | memberID | 會員ID | int (PK) | 原 會員ID |
| 2 | memberName | 會員姓名 | nvarchar(50) | 原 姓名 |
| 3 | gender | 性別 | tinyint | 原 性別 |
| 4 | birthDate | 生日 | date | 原 生日 |
| 5 | password | 密碼雜湊 | nvarchar(255) | 原 會員密碼 – 長度維持 |
| 6 | phoneNumber | 手機號碼 | nvarchar(20) | 原 手機號碼 |
| 7 | phoneVerifiedAt | 手機驗證通過時間 | datetime2(7) | 原 手機認證通過時間 |
| 8 | email | 電子信箱 | nvarchar(254) | 原 電子信箱 |
| 9 | emailVerifiedAt | Email驗證通過時間 | datetime2(7) | 原 email認證通過時間 |
|10 | identityVerifiedAt | 身分驗證通過時間 | datetime2(7) | 原 身分認證通過時間 |
|11 | lastLoginAt | 最後登入時間 | datetime2(7) | 原 最後登入時間 |
|12 | isActive | 是否啟用 | bit | 由「是否停用」反向改名；0=停用 1=啟用 |
|13 | primaryRentalCityID | 主要承租縣市ID | int | 原 主要承租縣市ID |
|14 | primaryRentalDistrictID | 主要承租區域ID | int | 原 主要承租區域ID |
|15 | residenceCityID | 居住縣市ID | int | 原 居住縣市ID |
|16 | residenceDistrictID | 居住區域ID | int | 原 居住區域ID |
|17 | memberTypeID | 會員身分別ID | int | 原 身分別ID (FK) |
|18 | isLandlord | 是否房東 | bit | 原 是否房東 |
|19 | addressLine | 詳細地址 | nvarchar(200) | 原 詳細地址 |
|20 | createdAt | 建立時間 | datetime2(7) | 原 帳號建立時間 |
|21 | updatedAt | 更新時間 | datetime2(7) | **新增** 持續更新時間 |


## 2. 會員身分表 (memberTypes)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 舊欄位來源／說明 |
|---|---|---|---|---|
| 1 | memberTypeID | 身分ID | int (PK) | 原 身分ID |
| 2 | typeName | 身分名稱 | nvarchar(30) | 原 身份名稱 |
| 3 | description | 描述 | nvarchar(100) | 原 描述 |
| 4 | isActive | 是否啟用 | bit | 原 是否啟用 |
| 5 | createdAt | 建立時間 | datetime2(7) | **新增** |
| 6 | updatedAt | 更新時間 | datetime2(7) | **新增** |


## 3. 通訊相關驗證表 (memberVerifications)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 舊欄位來源／說明 |
|---|---|---|---|---|
| 1 | verificationID | 驗證ID | int (PK) | 原 驗證編號ID |
| 2 | memberID | 會員ID | int | 原 會員ID (FK) |
| 3 | verificationTypeCode | 驗證類型代碼 | nvarchar(20) | 原 驗證類型代碼 → FK `systemCodes` |
| 4 | verificationCode | 驗證碼 | nvarchar(10) | 原 驗證碼 |
| 5 | isSuccessful | 是否驗證成功 | bit | 原 是否驗證成功 |
| 6 | sentAt | 發送時間 | datetime2(7) | 原 發送時間 |
| 7 | verifiedAt | 驗證完成時間 | datetime2(7) | **新增** |


## 4. 關聯與約束
- `members.memberTypeID` → `memberTypes.memberTypeID`
- `memberVerifications.memberID` → `members.memberID`
- `memberVerifications.verificationTypeCode` → `systemCodes.codeValue` (類別：VerificationType)

所有時間欄位統一 `datetime2(7)`；新增 `CHECK (isActive IN (0,1))` 等布林驗證。


# 尋租文章模組

## 1. 尋租文章資料表 (renterPosts)

|#|英文欄位|中文欄位|型別|來源/說明|
|---|---|---|---|---|
|1|postID|文章ID|int PK|原 文章編號|
|2|memberID|租客會員ID|int|原 租客會員編號|
|3|cityID|希望縣市ID|int|原 希望地點_縣市|
|4|districtID|希望區域ID|int|原 希望地點_區域|
|5|houseType|房屋類型|nvarchar(20)|原 房屋類型 (代碼)|
|6|budgetMin|預算下限|decimal(10,2)|原 預算範圍_最低金額|
|7|budgetMax|預算上限|decimal(10,2)|原 預算範圍_最高金額|
|8|content|詳細需求|nvarchar(MAX)|原 詳細需求描述|
|9|viewCount|瀏覽數|int|原 瀏覽數量|
|10|replyCount|回覆數|int|原 回覆數量|
|11|createdAt|發布時間|datetime2(7)|原 發布時間|
|12|updatedAt|最後編輯時間|datetime2(7)|原 最後編輯時間|
|13|deletedAt|刪除時間|datetime2(7)|新增|
|14|isActive|是否有效|bit|新增|

---

## 2. 尋租文章回覆資料表 (renterPostReplies)

|英文|中文|型別|說明|
|---|---|---|---|
|replyID|回覆ID|int PK||
|postID|文章ID|int FK||
|landlordMemberID|房東會員ID|int FK||
|content|回覆內容|nvarchar(MAX)||
|suggestPropertyID|推薦房源ID|int FK||
|isWithinBudget|符合預算|bit||
|tags|符合條件標籤|nvarchar(100)||
|createdAt|回覆時間|datetime2(7)||
|updatedAt|更新時間|datetime2(7)|新增||

---

## 3. 尋租文章需求條件清單 (renterRequirementList)
|欄位|說明|
|---|---|
|requirementID (PK,int)|條件ID|
|requirementName (nvarchar)|條件名稱|
|isActive (bit)|是否啟用|

## 4. 尋租條件關聯 (renterRequirementRelations)
|欄位|說明|
|---|---|
|relationID (PK,int)|關聯ID|
|postID (int FK)|文章ID|
|requirementID (int FK)|條件ID|

唯一鍵：`UNIQUE(postID, requirementID)`。

### 4.1 關聯與約束
```
-- FK 關聯
renterPosts.memberID           → members.memberID
renterPosts.cityID             → cities.cityID
renterPosts.districtID         → districts.districtID
renterPosts.houseType          → systemCodes.codeValue  -- 類別：HouseType

renterPostReplies.postID       → renterPosts.postID
renterPostReplies.landlordMemberID → members.memberID
renterPostReplies.suggestPropertyID → properties.propertyID (可 NULL)

renterRequirementRelations.postID       → renterPosts.postID
renterRequirementRelations.requirementID → renterRequirementList.requirementID

-- 唯一鍵與檢查
UNIQUE (renterRequirementRelations.postID, renterRequirementRelations.requirementID)
CHECK  (budgetMin  >= 0)
CHECK  (budgetMax  >= budgetMin)
CHECK  (viewCount  >= 0)
CHECK  (replyCount >= 0)
```


# 搜尋歷史與收藏模組資料（Search History & Favorites Module Optimization）

## 1. 搜索歷史表 (searchHistory／搜索歷史表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|historyId|歷史ID|bigint PK|雪花 ID (新增)|
|2|memberId|會員ID|int FK|members.id|
|3|keyword|搜尋關鍵字|nvarchar(255)|原 搜尋文字|
|4|resultCount|結果筆數|int NULL|搜尋結果筆數，後端傳回供熱門字統計 (新增)|
|5|deviceType|裝置|varchar(10) NULL|WEB/APP；用於裝置分群優化、A/B 測試 (新增)|
|6|ipAddress|IP|varchar(45) NULL|IPv6 亦可；用於風控與地域熱度分析 (新增)|
|7|searchedAt|搜尋時間|datetime2|原 搜尋時間點 (改名)|


## 2. 收藏表 (favorites／收藏表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|memberId|會員ID|int FK PK|members.id|
|2|propertyId|房源ID|int PK|原 房源編號 (改名)|
|3|isActive|是否有效|bit|收藏=1、取消=0；快速布林切換 (新增)|
|4|favoritedAt|收藏時間|datetime2|原 收藏時間點 (改名)|
|5|updatedAt|更新時間|datetime2|新增|

## 3. 關聯與索引建議
- favorites: 複合 PK `(memberId, propertyId)`；額外索引 `propertyId` 供統計。


*isActive vs. deletedAt 說明*：
- 選擇 `isActive`（布林）是因為「收藏」屬單一開關行為，查詢最常篩 `isActive = 1` 以取得目前有效收藏；
- 如需統計取消收藏，可輔以 `updatedAt` 判斷最後狀態改動時間；
- 若未來要精確記錄取消時間，可加欄位 `unfavoritedAt`；目前業務僅需布林旗標即可。 

# 租賃/看房申請模組

## 1. 租賃/看房申請資料表 (rentalApplications)

|#|英文欄位|中文|型別|說明|
|---|---|---|---|---|
|1|applicationID|申請ID|int PK|保留一個主鍵，自增|
|2|applicationType|申請類型|nvarchar(20)|HOUSE_VIEWING / RENTAL；FK systemCodes|
|3|memberID|申請會員ID|int FK|租客|
|4|propertyID|房源ID|int FK|
|5|message|申請留言|nvarchar(300)|原 申請者留言備註|
|6|scheduleTime|預約看房時間|datetime2(7)|原 預約看房時間|
|7|rentalStartDate|租期開始|date|原 租期開始日期|
|8|rentalEndDate|租期結束|date|原 租期結束日期|
|9|currentStatus|目前狀態|nvarchar(20)|FK systemCodes (ApplicationStatus)|
|10|createdAt|申請時間|datetime2(7)|原 申請時間|
|11|updatedAt|更新時間|datetime2(7)|新增|
|12|deletedAt|刪除時間|datetime2(7)|新增|
|13|isActive|是否有效|bit|新增|

---

## 2. 申請狀態歷程表 (applicationStatusLogs)

|#|英文欄位|中文|型別|說明|
|---|---|---|---|---|
|1|statusLogID|狀態歷程ID|int PK|原 狀態歷程ID|
|2|applicationID|申請ID|int FK|原 申請編號ID|
|3|statusCode|狀態代碼|nvarchar(20)|FK systemCodes|
|4|changedAt|進入狀態時間|datetime2(7)|原 進入狀態時間|
|5|note|備註|nvarchar(MAX)|房東備註/拒絕理由/改期理由等|
|6|updatedAt|更新時間|datetime2(7)|新增|

UNIQUE (applicationID, statusCode, changedAt)


## 3. 關聯與約束
```
-- rentalApplications
memberID   → members.memberID
propertyID → properties.propertyID
applicationType → systemCodes.codeValue (類別：ApplicationType)
currentStatus   → systemCodes.codeValue (類別：ApplicationStatus)

-- applicationStatusLogs
applicationID → rentalApplications.applicationID
statusCode → systemCodes.codeValue (ApplicationStatus)

CHECK (isActive IN (0,1))
CHECK (rentalEndDate >= rentalStartDate OR rentalEndDate IS NULL)
```

# 房源基本資料模組

## 1. 房源資料表 (properties)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 說明／舊欄位來源 |
|---|---|---|---|---|
| 1 | propertyID | 房源ID | int (PK) | 原 房源編號，自增 |
| 2 | landlordMemberID | 房東會員ID | int | 原 房東會員編號，FK `members` |
| 3 | title | 房源標題 | nvarchar(100) | 原 房源標題 (限制長度) |
| 4 | description | 詳細描述 | nvarchar(MAX) | 原 詳細描述 |
| 5 | cityID | 縣市ID | int | 從文字 `地址_縣市` 改 FK `cities` |
| 6 | districtID | 區域ID | int | 從文字 `地址_區域` 改 FK `districts` |
| 7 | addressLine | 詳細地址 | nvarchar(200) | 原 地址_詳細地址 |
| 8 | monthlyRent | 月租金 | decimal(10,2) | 原 每月租金 |
| 9 | depositAmount | 押金金額 | decimal(10,2) | 原 押金金額 |
|10 | depositMonths | 押金月數 | int | 原 押金月數 |
|11 | roomCount | 房數 | int | 原 格局_房數 |
|12 | livingRoomCount | 廳數 | int | 原 格局_廳數 |
|13 | bathroomCount | 衛數 | int | 原 格局_衛數 |
|14 | currentFloor | 所在樓層 | int | 原 樓層_所在樓層 |
|15 | totalFloors | 總樓層 | int | 原 樓層_總樓層 |
|16 | area | 坪數 | decimal(8,2) | 原 坪數 |
|17 | minimumRentalMonths | 最短租期(月) | int | 從 nvarchar 解析；統一整數月 |
|18 | specialRules | 特殊守則 | nvarchar(MAX) | 原 房屋的特殊守則 |
|19 | waterFeeType | 水費計算方式 | nvarchar(20) | 原 水費計算方式 (代碼) |
|20 | customWaterFee | 自訂水費 | decimal(8,2) | 原 自訂水費金額 |
|21 | electricityFeeType | 電費計算方式 | nvarchar(20) | 原 電費計算方式 |
|22 | customElectricityFee | 自訂電費 | decimal(8,2) | 原 自訂電費金額 |
|23 | managementFeeIncluded | 管理費含租金 | bit | 原 管理費_是否包含租金 |
|24 | managementFeeAmount | 管理費金額 | decimal(8,2) | 原 管理費_每月金額 |
|25 | parkingAvailable | 有停車位 | bit | 原 有停車位 |
|26 | parkingFeeRequired | 停車位需額外收費 | bit | 原 停車位_是否額外收費 |
|27 | parkingFeeAmount | 停車位費用 | decimal(8,2) | 原 停車位_費用 |
|28 | cleaningFeeRequired | 清潔費需額外收費 | bit | 原 清潔費_是否額外收費 |
|29 | cleaningFeeAmount | 清潔費金額 | decimal(8,2) | 原 清潔費_費用 |
|30 | listingDays | 刊登天數 | int | 原 刊登天數 |
|31 | listingFeeAmount | 刊登費用 | decimal(10,2) | 原 刊登費用 |
|32 | listingPlanID | 刊登費方案ID | int | 原 刊登費方案 (FK `listingPlans`) |
|33 | isPaid | 付款狀態 | bit | **新增** 0=未付 1=已付 |
|34 | paidAt | 完成付款時間 | datetime2(7) | **新增** |
|35 | expireAt | 上架到期時間 | datetime2(7) | **新增** |
|36 | propertyProofURL | 房產證明文件URL | nvarchar(500) | 原 房產證明文件URL |
|37 | previewImageURL | 預覽圖連結 | nvarchar(500) | 原 預覽圖連結 |
|38 | statusCode | 房源狀態代碼 | nvarchar(20) | 原 房源狀態 → FK `systemCodes` |
|39 | publishedAt | 上架日期 | datetime2(7) | 原 上架日期 |
|40 | updatedAt | 最後修改日期 | datetime2(7) | 原 最後修改日期 |
|41 | createdAt | 建立時間 | datetime2(7) | **新增** |
|42 | deletedAt | 刪除時間 | datetime2(7) | **軟刪除**，可 NULL |

### 1.5 關聯與約束
- `properties.landlordMemberID` → `members.memberID`
- `properties.cityID` → `cities.cityID`
- `properties.districtID` → `districts.districtID`
- `properties.statusCode` → `systemCodes.codeValue` (類別：PropertyStatus)
- `properties.listingPlanID` → `listingPlans.planID`

金額欄位加 `CHECK (amount >= 0)`；面積 > 0；樓層不得為負值等。

## 2. 房源圖片表 (propertyImages)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 舊欄位來源／說明 |
|---|---|---|---|---|
| 1 | imageID | 圖片ID | int (PK, IDENTITY) | 原 圖片編號 |
| 2 | propertyID | 房源ID | int | 原 房源編號 (FK) |
| 3 | imagePath | 圖片路徑 | nvarchar(500) | 原 圖片路徑 |
| 4 | displayOrder | 顯示順序 | int | 原 顯示順序 |
| 5 | createdAt | 建立時間 | datetime2(7) | **新增** 上傳時間 |

### 2.4 關聯與約束
- `propertyImages.propertyID` → `properties.propertyID`
- `UNIQUE (propertyID, displayOrder)` 保證排序唯一。



# 房源設備模組


## 1. 房源設備分類資料表 (propertyEquipmentCategories)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 說明／舊欄位來源 |
|---|---|---|---|---|
| 1 | categoryID | 設備分類ID | int (PK) | 原 設備編號 |
| 2 | parentCategoryID | 上層分類ID | int | 原 設備分類；FK self-reference，可 NULL |
| 3 | categoryName | 設備名稱 | nvarchar(50) | 原 設備名稱 |
| 4 | isActive | 是否啟用 | bit | **新增** |
| 5 | createdAt | 建立時間 | datetime2(7) | **新增** |
| 6 | updatedAt | 更新時間 | datetime2(7) | **新增** |

### 1.4 使用說明與範例
以下示範如何在單表內透過 `parentCategoryID` 建立「四大類 → 多個具體設備」階層。

| categoryID | categoryName | parentCategoryID | 層級說明 |
|-----------|-------------|------------------|---------|
| 1 | 建物設備 | NULL | 第一層（Top Level）|
| 2 | 室內設備 | NULL | 第一層 |
| 3 | 家具家電 | NULL | 第一層 |
| 4 | 其他 | NULL | 第一層 |
| 5 | 游泳池 | 1 | 第二層；屬於「建物設備」|
| 6 | 陽台 | 2 | 第二層；屬於「室內設備」|
| 7 | 冷氣 | 3 | 第二層；屬於「家具家電」|
| 8 | 可養寵 | 4 | 第二層；屬於「其他」|

操作指引：
1. **新增分類**：
   - 若要新增最上層分類，`parentCategoryID` 設為 NULL。
   - 若要新增第二層／第三層…分類，`parentCategoryID` 指向對應母分類 `categoryID`。
2. **房東選擇設備**：後台僅顯示第二層（或更深）選項；儲存時直接記錄該分類的 `categoryID` 至 `propertyEquipmentRelations.categoryID`。
3. **前端顯示**：
   - 顯示完整路徑可遞迴向上追溯 parent，組成「建物設備 > 游泳池」。
   - 若只顯示名稱，可直接使用 `categoryName`。
4. **查詢篩選**：
   - 以房源搜尋「某一大類的所有設備」時，可先找出該大類的 `categoryID`，再遞迴取得所有子分類 ID 進行 IN 查詢。
5. **資料完整性**：
   - 建議對 `parentCategoryID` 加 `FOREIGN KEY` 約束並使用 `ON DELETE SET NULL`，避免意外刪除母分類造成子分類孤兒。

> 如確定永遠只使用兩層，亦可於 UI 層固定限制；資料表仍保留往下擴充彈性。

## 2. 房源設備關聯資料表 (propertyEquipmentRelations)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 說明／舊欄位來源 |
|---|---|---|---|---|
| 1 | relationID | 關聯ID | int (PK) | 原 關聯編號 |
| 2 | propertyID | 房源ID | int | 原 房源編號；FK `properties` |
| 3 | categoryID | 設備分類ID | int | 原 設備編號；FK `equipmentCategories` |
| 4 | quantity | 數量 | int | 原 數量；`CHECK (quantity > 0)` |
| 5 | createdAt | 建立時間 | datetime2(7) | **新增** |
| 6 | updatedAt | 更新時間 | datetime2(7) | **新增** |

### 2.4 索引與約束
- `UNIQUE (propertyID, categoryID)` 防止重複。
- `quantity > 0` 檢查約束。


# 房源審核紀錄模組

## 1. 房源審核紀錄資料表 (propertyAuditLogs)

### 1.1 整合策略
- 將審核主檔搬至 `approvals`，設定 `moduleCode = 'PROPERTY'`。  
- 付款、上架到期時間屬於「刊登方案」流程，建議存於 `listingPlans` or `properties` 自身欄位（已在房源模組中含 `listingDays`, `publishedAt`）。  
- `房源證明文件URL` 與 `更新快照` 保留於快照明細表，以備追溯。

#### approvals (審核主檔) – 新增 Property 專用紀錄
| # | 欄位 (英文) | 欄位 (中文) | 資料型別 | 說明 |
|---|---|---|---|---|
| approvalID | 審核ID | int (PK) | 原 審核紀錄編號 |
| moduleCode | 模組代碼 | nvarchar(20) | 固定 'PROPERTY' |
| sourceID | 來源ID | int | = 房源ID |
| applicantMemberID | 申請會員ID | int | 房東會員ID |
| statusCode | 審核狀態碼 | nvarchar(20) | 原 審核結果代碼（轉為字串）|
| currentApproverID | 目前審核人員ID | int | 後台審核人員 |
| createdAt | 建立時間 | datetime2(7) | 房東提交審核申請時間 |
| updatedAt | 更新時間 | datetime2(7) | 後台審核通過時間或後續更新 |

#### approvalItems (審核明細) – 留存歷史與快照
| # | 欄位 | 資料型別 | 說明 |
|---|---|---|---|
| approvalItemID | int (PK) | |
| approvalID | int | FK → approvals |
| actionBy | int | 管理員或系統 |
| actionType | nvarchar(20) | SUBMIT / APPROVE / REJECT / PAY_CONFIRM |
| actionNote | nvarchar(MAX) | 包含 `房源證明文件URL` 或 `問題描述` |
| snapshotJSON | nvarchar(MAX) | 原 更新快照 |
| createdAt | datetime2(7) | |

#### properties (補充欄位，已存在)
| 欄位 | 說明 |
|---|---|
| paidAt | 房東完成付款時間 (datetime2(7)) |
| expireAt | 上架到期時間 (datetime2(7)) |
| isPaid | 付款狀態 (bit) |

### 1.7 關聯與約束
```
-- approvals 表 (模組代碼固定 'PROPERTY')
approvals.moduleCode       → systemCodes.codeValue  -- 類別：ApprovalModule
approvals.statusCode       → systemCodes.codeValue  -- 類別：ApprovalStatus
approvals.sourceID         → properties.propertyID
approvals.applicantMemberID→ members.memberID
approvals.currentApproverID→ admins.adminID (可 NULL)

UNIQUE (approvals.moduleCode, approvals.sourceID)   -- 一個房源僅有一條現行審核主紀錄

-- approvalItems
approvalItems.approvalID   → approvals.approvalID
CHECK (actionType IN ('SUBMIT','APPROVE','REJECT','PAY_CONFIRM'))

-- properties 補充欄位
CHECK (isPaid IN (0,1))

-- 索引建議
CREATE INDEX IX_Approvals_Source ON approvals (moduleCode, sourceID);
CREATE INDEX IX_ApprovalItems_ApprovalId ON approvalItems (approvalID);
```


# 平台費用模組資料（Platform Fee Module Optimization）

## 1. 刊登費方案表 (listingPlans／刊登費表)

|#|英文欄位|中文欄位|型別|來源/說明|
|---|---|---|---|---|
|1|planId|方案ID|int PK|自動遞增 (新增)|
|2|planName|方案名稱|nvarchar(50)|原 刊登費方案名稱 (擴充長度)|
|3|pricePerDay|每日刊登費|decimal(10,2)|原 刊登費(一天) (改型)|
|4|currencyCode|幣別|varchar(3)|ISO 4217，如 TWD (新增)|
|5|minListingDays|最小上架天數|int|原 最小上架天數|
|6|startAt|生效時間|datetime2|原 生效時間 (改型)|
|7|endAt|結束時間|datetime2 NULL|原 結束時間 (改型 + 允許 NULL)|
|8|isActive|是否啟用|bit|0/1 (新增)|
|9|createdAt|建立時間|datetime2|新增|
|10|updatedAt|更新時間|datetime2|新增|

## 2. 家具配送費方案表 (deliveryFeePlans／家具配送費表)

|#|英文欄位|中文欄位|型別|來源/說明|
|---|---|---|---|---|
|1|planId|配送方案ID|int PK|自動遞增 (新增)|
|2|planName|方案名稱|nvarchar(50)|原 方案名稱 (擴充)|
|3|baseFee|基本費用|decimal(10,2)|原 基本費用 (改型)|
|4|remoteAreaSurcharge|偏遠加收|decimal(10,2)|原 偏遠加收 (改型)|
|5|currencyCode|幣別|varchar(3)|TWD (新增)|
|6|startAt|生效時間|datetime2|原 生效時間 (改型)|
|7|endAt|結束時間|datetime2 NULL|原 結束時間 (改型)|
|8|maxWeightKG|重量上限KG|decimal(6,2) NULL|新增，便於分級|
|9|isActive|是否啟用|bit|0/1 (新增)|
|10|createdAt|建立時間|datetime2|新增|
|11|updatedAt|更新時間|datetime2|新增|

## 3. 關聯與索引建議
- listingPlans / deliveryFeePlans: 索引 `startAt`, `endAt`, `isActive`。  
- 若多幣別，可複合索引 `(currencyCode, isActive)`。


# 平台內容管理模組資料（Platform Content Module Optimization）

## 1. 輪播圖片表 (carouselImages／輪播圖片表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|圖片ID|int PK|圖片編號|
|2|name|名稱|nvarchar(50)|名稱 (擴充長度)|
|3|category|分類|varchar(20)|首頁Hero / 促銷Banner 等 ENUM|
|4|imageUrl|圖片URL|nvarchar(255)|路徑 → imageUrl|
|5|pageCode|頁面識別碼|varchar FK|對應 pages.pageCode|
|6|displayOrder|顯示順序|int|輪播圖顯示順序|
|7|startAt|開始時間|datetime2|開始時間|
|8|endAt|結束時間|datetime2|結束時間|
|9|isActive|是否啟用|bit|0/1|
|10|createdAt|建立時間|datetime2|新增|
|11|updatedAt|更新時間|datetime2|新增|
|12|deletedAt|刪除時間|datetime2|新增|

## 2. 頁面代碼表 (pages／共用頁面代碼表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|pageCode|頁面識別碼|varchar PK|頁面代號 (改用字串，如 FURN_HOME)|
|2|pageName|頁面名稱|nvarchar(50)|頁面名稱 (擴充長度)|
|3|routePath|路徑|varchar(100)|前端 Router Path，如 `/furniture`|
|4|moduleScope|模組|varchar(20)|LANDLORD / TENANT / FURNITURE…|
|5|isActive|是否啟用|bit|0/1|
|6|displayOrder|顯示順序|int|後台排序|
|7|createdAt|建立時間|datetime2|新增|
|8|updatedAt|更新時間|datetime2|新增|

## 3. 關聯與約束建議
- `carouselImages.pageCode` → `pages.pageCode` (ON DELETE SET NULL)
- 為 `carouselImages.startAt`,`carouselImages.endAt` 建索引支援定時上下架。
- 為 `pages.moduleScope`,`pages.isActive` 建複合索引，方便後台篩選。


# 通知與訊息模組資料（Notification & Messaging Module Optimization）

## 1. 使用者通知資料表 (userNotifications／使用者通知資料表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|notificationId|通知ID|int PK|自動遞增 (新增)|
|2|receiverId|接收者ID|int FK|members.id|
|3|senderId|發送者ID|int FK NULL|members.id (可為系統)|
|4|typeCode|通知類型代碼|varchar(20) FK|systemCodes.code (取代通知類型)|
|5|title|訊息標題|nvarchar(100)|原 訊息標題 (長度擴充)|
|6|content|訊息內容|nvarchar(max)|原 訊息內容 (長度擴充)|
|7|linkUrl|相關連結URL|varchar(255) NULL|原 相關連結路徑/編號 (改名+擴充)|
|8|moduleCode|來源模組代碼|varchar(50) FK|sourceModules.moduleCode (改型+改名)|
|9|sourceEntityId|來源資料ID|int|原 來源ID (改名)|
|10|statusCode|狀態代碼|varchar(20) FK|systemCodes.code (取代狀態) (新增)|
|11|isRead|是否已讀|bit|0/1|
|12|readAt|閱讀時間|datetime2 NULL|實際開啟時間 (新增)|
|13|sentAt|發送時間|datetime2|原 發送時間→sentAt|
|14|createdAt|建立時間|datetime2|與 sentAt 同步記錄 (新增)|
|15|updatedAt|更新時間|datetime2|最後更新時間 (新增)|
|16|deletedAt|刪除時間|datetime2 NULL|軟刪除 (新增)|

## 2. 系統訊息表 (systemMessages／系統訊息表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|messageId|系統訊息ID|int PK|自動遞增 (新增)|
|2|categoryCode|訊息類別代碼|varchar(20) FK|systemCodes.code (改型)|
|3|audienceTypeCode|接受者類型代碼|varchar(20) FK|systemCodes.code (改型)|
|4|receiverId|個別接受者ID|int FK NULL|members.id|
|5|title|發送標題|nvarchar(100)|原 發送標題 (長度擴充)|
|6|content|發送內容|nvarchar(max)|原 發送內容 (長度擴充)|
|7|attachmentUrl|附件URL|varchar(255) NULL|原 附件URL (改型)|
|8|sentAt|發送時間|datetime2|原 發送時間|
|9|adminId|發送管理員ID|int FK|admins.id|
|10|isActive|是否啟用|bit|0/1 (新增)|
|11|createdAt|建立時間|datetime2|與 sentAt 同步 (新增)|
|12|updatedAt|更新時間|datetime2|最後更新時間 (新增)|
|13|deletedAt|刪除時間|datetime2 NULL|軟刪除 (新增)|

## 3. 後台訊息模板表 (adminMessageTemplates／後台訊息模板表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|templateId|模板ID|int PK|自動遞增 (新增)|
|2|categoryCode|模板類別代碼|varchar(20) FK|systemCodes.code (改型)|
|3|title|標題|nvarchar(100)|原 標題 (長度擴充)|
|4|content|內容|nvarchar(max)|原 內容 (長度擴充，可含 {{placeholder}})|
|5|isActive|是否啟用|bit|0/1|
|6|createdAt|建立時間|datetime2|原 建立時間|
|7|updatedAt|更新時間|datetime2|原 更新時間|


## 4. 關聯與約束建議
- `userNotifications.receiverId`、`systemMessages.receiverId` → `members.id` (ON DELETE CASCADE)
- `adminId` → `admins.id`。
- `typeCode`, `statusCode`, `categoryCode`, `audienceTypeCode` 皆參照 `systemCodes.code`，需限定 `codeCategory`。
- `moduleCode` → `sourceModules.moduleCode` (ON DELETE SET NULL)。
- `templateId` 可於 `systemMessages` 保留欄位 (此處略) 以追蹤來源模板。
- `sentAt`、`createdAt` 欄位建立索引，支援時間區間查詢。


# 審核模組 – 資料表優化細節

## 1. 審核表 (landlordApprovals)

#### approvals (審核主檔)
| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 說明 |
|---|---|---|---|---|
| 1 | approvalID | 審核ID | int (PK) | 原 申請ID 對應 |
| 2 | moduleCode | 模組代碼 | nvarchar(20) | 固定 'LANDLORD' 表示房東審核；FK `systemCodes` |
| 3 | sourceID | 來源ID | int | 原 會員ID (被審核者) |
| 4 | applicantMemberID | 申請會員ID | int | = sourceID |
| 5 | statusCode | 審核狀態碼 | nvarchar(20) | 取代 申請狀態代碼；FK `systemCodes` |
| 6 | currentApproverID | 目前審核人員ID | int | 原 審核人員ID |
| 7 | createdAt | 建立時間 | datetime2(7) | 原 申請時間 (統一命名) |
| 8 | updatedAt | 更新時間 | datetime2(7) | 原 更新時間 (統一型別) |

#### approvalItems (審核明細)
| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 說明 |
|---|---|---|---|---|
| 1 | approvalItemID | 審核明細ID | int (PK) | |
| 2 | approvalID | 審核ID | int | FK → approvals |
| 3 | actionBy | 操作者ID | int | 管理員或系統 |
| 4 | actionType | 操作類型 | nvarchar(20) | APPROVE / REJECT / COMMENT |
| 5 | actionNote | 行動備註 | nvarchar(MAX) | 包含拒絕原因 |
| 6 | createdAt | 建立時間 | datetime2(7) | |

## 2. 關聯與約束
- `approvals.moduleCode` → `systemCodes.codeValue` (類別：ApprovalModule)
- `approvals.statusCode` → `systemCodes.codeValue` (類別：ApprovalStatus)
- `approvals.currentApproverID` → `admins.adminID`
- `approvals.sourceID` / `applicantMemberID` → `members.memberID`
- `approvalItems.approvalID` → `approvals.approvalID`

> 當有其他模組（房源審核、檔案審核等）亦需審核流程，可共用 `approvals` 及 `approvalItems` 兩表，僅以 `moduleCode` 區分。


# 家具商品與分類模組資料（Furniture Products Module Optimization）

## 1. 家具商品分類表 (furnitureCategories)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|分類ID|varchar PK|分類編號|
|2|parentId|上層分類ID|varchar FK|上層分類|
|3|name|分類名稱|nvarchar(50)|分類名稱|
|4|depth|階層層級|tinyint|新增 (根=0)|
|5|displayOrder|顯示排序|int|新增|
|6|createdAt|建立時間|datetime|新增|
|7|updatedAt|更新時間|datetime|新增|


## 2. 家具商品資料表 (furnitureProducts)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|商品ID|varchar PK|商品編號|
|2|categoryId|分類ID|varchar FK|分類編號|
|3|productName|商品名稱|nvarchar(100)|商品名稱|
|4|description|商品描述|nvarchar(max)|商品描述|
|5|listPrice|原價|decimal(10,0)|原價|
|6|dailyRental|每日租金|decimal(10,0)|每日租金|
|7|imageUrl|商品圖片URL|nvarchar(255)|商品圖片|
|8|status|上下架狀態|bit|上下架狀態|
|9|listedAt|上架時間|date|上架時間|
|10|delistedAt|下架時間|date|下架時間|
|11|createdAt|建立時間|datetime|新增|
|12|updatedAt|更新時間|datetime|新增|
|13|deletedAt|刪除時間|datetime|新增 (軟刪除)|

> **補充說明**：商品名稱／描述的歷史快照（如 `productNameSnapshot`、`descriptionSnapshot`）由「家具訂單與歷史模組」保存，本模組僅維護最新值，不重複儲存。

---

## 3. 家具庫存表 (furnitureInventory)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|庫存ID|varchar PK|庫存編號|
|2|productId|商品ID|varchar FK|商品編號|
|3|totalQuantity|總庫存數量|int|總庫存數量|
|4|rentedQuantity|已出租數量|int|已出租數量|
|5|availableQuantity|可用庫存|int|可用庫存|
|6|safetyStock|安全庫存|int|新增|
|7|updatedAt|最後更新時間|datetime|最後更新時間|

### 3.4 inventoryEvents（庫存事件表）
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|事件ID|uuid PK|新增|
|2|productId|商品ID|varchar FK|對應 furnitureProducts.id|
|3|eventType|事件類型|varchar(20)|out_rent / in_return / adjust 等|
|4|quantity|異動數量|int|正值=入庫；負值=出庫|
|5|sourceType|來源類型|varchar(20)|order / refund / manual|
|6|sourceId|來源編號|varchar|對應來源主鍵|
|7|occurredAt|業務時間|datetime|事件實際發生時間|
|8|recordedAt|寫入時間|datetime|預設 CURRENT_TIMESTAMP|

> 新增理由：
> 1. 滿足溯源需求：所有庫存異動留不可變日誌，可回放、稽核。
> 2. 與家具訂單模組鬆耦合：訂單服務僅需發佈事件，不直接操作庫存表。
> 3. 支援補償機制：若誤扣庫存，只需寫入一筆 `adjust_in` 事件，無需 UPDATE。
>
> 實例：下單租出 3 件書桌（productId = FD001）。服務產生：
> `INSERT inventoryEvents VALUES (uuid(), 'FD001', 'out_rent', -3, 'order', 'ORD123', @now, DEFAULT);`
>
> Consumer 讀取後，同步：
> `UPDATE furnitureInventory SET rentedQuantity += 3, availableQuantity -= 3, updatedAt = GETDATE()`。

### 3.5 庫存欄位實作用法說明
1. `totalQuantity`：期初入庫 + 所有入庫事件 (adjust_in/in_return) − 出庫事件 (adjust_out/out_rent)。
2. `rentedQuantity`：累加所有 `out_rent` 未歸還數量，歸還時以 `in_return` 抵銷。
3. `availableQuantity`：`totalQuantity - rentedQuantity`，亦於每次事件同步更新，保持即時查詢。
4. `safetyStock`：安全庫存值，當 `availableQuantity < safetyStock` 時觸發警報。

> 透過事件→快照模式，即可 `SELECT availableQuantity FROM furnitureInventory WHERE productId='FD001'` 在 O(1) 時間取得即時庫存；若需歷史庫存，則 `SUM(quantity)` over `inventoryEvents` until 某時點。

### 3.6 詳述
|新增|inventoryEvents 表|提供溯源、補償、稽核能力|事件驅動，同步更新快照，提高效能|
|新增|safetyStock|安全庫存門檻|便於後台警示，避免超賣|

---

## 4. 關聯與約束建議
- `furnitureProducts.categoryId` → `furnitureCategories.id` (ON DELETE SET NULL)
- `furnitureInventory.productId` → `furnitureProducts.id` (ON DELETE CASCADE)
- `furnitureCategories.parentId` 自關聯 (ON DELETE SET NULL)
- 為 `furnitureProducts.status`, `furnitureInventory.availableQuantity` 建立索引。
- `inventoryEvents.productId` → `furnitureProducts.id` (ON DELETE CASCADE)
- 建立 `idx_inventoryEvents_product_time` (`productId`,`occurredAt`) 以便按商品與時間篩選事件。
- 建立 `CHK_inventory_positive` 檢查約束：`totalQuantity >= 0 AND rentedQuantity >= 0 AND availableQuantity >= 0 AND safetyStock >= 0`。
- 為 `furnitureProducts.status`、`furnitureInventory.availableQuantity` 建立索引，以支援上架篩選與庫存告警。
- 事件消費邏輯：應在應用層或觸發器中保證 `inventoryEvents` 被寫入後，同步更新 `furnitureInventory` 對應欄位。

## 8. 整體架構與實作示例

### 8.1 架構概覽
```
(文字示意圖)
Client / Admin UI → API Gateway → Order Service ───▶ ❶ `OrderCreated` 事件
                                   │                              │
                                   │                              ▼
                                   │                    Message Broker / Event Bus
                                   ▼                              │
                            Inventory Command Handler ───▶ ❷ `inventoryEvents` 寫入
                                   │                              │
                                   │                              ▼
                                   └────────────▶ Snapshot Updater (Consumer) ──┐
                                                                      │         │
                                                                      ▼         ▼
                                                              `furnitureInventory` (快照)     `alerts` (告警)
```
- 寫入面（CQRS Command）：所有庫存異動只寫入 `inventoryEvents`，確保事件溯源。
- 讀取面（CQRS Query）：前端查詢僅讀取 `furnitureInventory` 快照，O(1) 取得可用庫存。
- 事件消費者負責將事件累積計算後「投影」至快照表，若投影失敗可重播事件。

### 8.2 典型流程示例
1. **下單租賃**
   1. Order Service 建立訂單資料，發佈 `OrderCreated {orderId, productId, qty}`。
   2. Inventory Command Handler 轉換為 `inventoryEvents`：`eventType=out_rent`, `quantity=-qty`。
   3. Consumer 讀取事件，更新快照：`rentedQuantity += qty; availableQuantity -= qty`。
   4. 若 `availableQuantity < safetyStock` 則寫入 `alerts` 並通知後台。
2. **歸還商品**
   1. Order Service 發佈 `ReturnCompleted`，轉成 `in_return` 正值事件。
   2. 快照對應減少 `rentedQuantity`、增加 `availableQuantity`。
3. **手動調整庫存** (盤點、報損)
   1. 管理介面呼叫 Admin API，寫入 `adjust_in` / `adjust_out` 類型之事件。
   2. Consumer 重算並更新快照。
4. **快照重建**
   - 發生資料不一致時，可清空 `furnitureInventory`，自最早事件時間點重播 `inventoryEvents` 重建快照。

### 8.3 查詢與報表
- **即時庫存**：`SELECT availableQuantity FROM furnitureInventory WHERE productId=?`。
- **歷史庫存**：`SELECT SUM(quantity) FROM inventoryEvents WHERE productId=? AND occurredAt<=@timestamp`。
- **月報**：以事件表 Group By `eventType`, `MONTH(occurredAt)` 快速生成入庫 / 出庫 / 租賃統計。

### 8.4 實作注意事項
| 主題 | 重點 | 建議做法 |
|------|------|----------|
|Idempotency|保證事件「至多一次」投影|Consumer 以 `eventId` 去重；Snapshot 表加 `lastEventId` 欄位|
|併發控制|防止多消費者同時更新快照|使用樂觀鎖 (rowversion) 或 `WHERE version = ?` 方式 UPDATE|
|可靠傳遞|避免事件遺失|採 Outbox Pattern + 事務發佈；Broker 建議使用支援持久化之 Kafka/Rabbit|
|補償機制|誤扣庫存時恢復|寫入反向 `adjust_in` 事件，保持事件不可修改|
|監控告警|安全庫存不足|Trigger 或批次 Job 檢查 `availableQuantity < safetyStock` 寫入告警表|
|資料分區|大表管理|`inventoryEvents` 依月份/年份或商品類別分區，提高查詢效率|
|備份恢復|事件大於快照|先恢復事件表再重建快照；快照可捨棄再生成|

### 8.5 延伸規劃
- **多倉庫**：`warehouseId` 加入事件與快照表即可支援。
- **讀寫分離**：快照表可複製至只讀節點，供報表系統使用；事件表保留在主庫。
- **流量高峰**：可將 Consumer 水平擴充，前置依序處理之分割槽機制確保同一商品順序一致。 

# 家具訂單與歷史模組資料（Furniture Orders & History Module Optimization）

## 1. 家具購物車表 (furnitureCarts)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|購物車ID|varchar PK|CSV 原欄位「購物車編號」|
|2|memberId|會員ID|varchar FK|CSV 原欄位「所屬會員」|
|3|propertyId|房源ID|varchar FK|CSV 原欄位「選擇房源」|
|4|status|狀態|varchar(20)|新增|
|5|createdAt|建立時間|datetime|CSV 原欄位「建立時間」|
|6|updatedAt|更新時間|datetime|新增|
|7|deletedAt|刪除時間|datetime|新增|

## 2. 家具購物車明細表 (furnitureCartItems)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|明細ID|varchar PK|CSV 原欄位「明細編號」|
|2|cartId|購物車ID|varchar FK|CSV 原欄位「所屬購物車」|
|3|productId|商品ID|varchar FK|CSV 原欄位「商品編號」|
|4|quantity|數量|int|CSV 原欄位「數量」|
|5|rentalDays|租期(天)|int|CSV 原欄位「租期」|
|6|unitPriceSnapshot|單價快照|decimal(10,0)|新增|
|7|subTotal|小計|decimal(12,0)|CSV 原欄位「小計」|
|8|createdAt|建立時間|datetime|新增|

## 3. 家具訂單查詢表 (furnitureOrders)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|訂單ID|varchar PK|CSV 原欄位「訂單編號」|
|2|memberId|會員ID|varchar FK|CSV 原欄位「會員編號」|
|3|propertyId|房源ID|varchar FK|CSV 原欄位「房源編號」|
|4|createdAt|成立時間|datetime|CSV 原欄位「訂單成立時間」|
|5|totalAmount|總金額|decimal(12,0)|CSV 原欄位「金額」|
|6|status|訂單狀態|varchar(20)|CSV 原欄位「狀態」 (FK 合約) |
|7|paymentStatus|付款狀態|varchar(20)|CSV 原欄位「付款狀態」|
|8|contractLink|合約連結|nvarchar(255)|CSV 原欄位「合約連結」|
|9|updatedAt|更新時間|datetime|新增|
|10|deletedAt|刪除時間|datetime|新增|

## 4. 家具訂單查詢明細表 (furnitureOrderItems)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|明細ID|varchar PK|CSV 原欄位「明細編號」|
|2|orderId|訂單ID|varchar FK|CSV 原欄位「對應訂單」|
|3|productId|商品ID|varchar FK|CSV 原欄位「商品編號」|
|4|quantity|數量|int|CSV 原欄位「租借數量」|
|5|dailyRentalSnapshot|單日租金快照|decimal(10,0)|CSV 原欄位「單日租金」|
|6|rentalDays|租期(天)|int|CSV 原欄位「租借天數」|
|7|subTotal|小計|decimal(12,0)|CSV 原欄位「小計」|
|8|createdAt|建立時間|datetime|新增|

## 5. 訂單事件表 (orderEvents)

### 5.1 設計目的
1. 保存訂單完整生命週期（created／paid／out_rent／in_return／cancelled／refunded）。
2. 與 `inventoryEvents` 對稱，支援事件溯源、補償、稽核。
3. 為 CQRS 投影提供單一寫入來源。

### 5.2 資料表結構
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|--|-----------|-----------|------|-----------|
|1|id|事件ID|uuid PK|新增|
|2|orderId|訂單ID|varchar FK|對應 furnitureOrders.id|
|3|eventType|事件類型|varchar(30)|created / paid / out_rent / in_return / cancelled / refunded|
|4|payload|事件內容|json|彈性欄位，保存差異值|
|5|occurredAt|業務時間|datetime|事件實際發生時間|
|6|recordedAt|寫入時間|datetime|預設 CURRENT_TIMESTAMP|

## 6. 家具歷史訂單清單 (furnitureOrderHistory)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|流水號|varchar PK|CSV 原欄位「訂單明細流水號」|
|2|orderId|訂單ID|varchar FK|CSV 原欄位「對應訂單編號」|
|3|productId|商品ID|varchar FK|CSV 原欄位「對應商品」|
|4|productNameSnapshot|商品名稱快照|nvarchar(100)|新增 (來源 furnitureProducts.productName)|
|5|descriptionSnapshot|商品描述快照|nvarchar(max)|新增 (來源 furnitureProducts.description)|
|6|quantity|數量|int|CSV 原欄位「數量」|
|7|dailyRentalSnapshot|單日租金快照|decimal(10,0)|CSV 原欄位「單日租金」|
|8|rentalStart|租借開始日|date|CSV 原欄位「租借開始日」|
|9|rentalEnd|租借結束日|date|CSV 原欄位「租借結束日」|
|10|subTotal|小計|decimal(12,0)|CSV 原欄位「小計」|
|11|itemStatus|明細狀態|nvarchar(50)|CSV 原欄位「明細狀態」|
|12|returnedAt|實際歸還日期|date|CSV 原欄位「實際歸還日期」|
|13|damageNote|損壞說明|nvarchar(255)|CSV 原欄位「損壞說明」|
|14|createdAt|建立時間|datetime|新增|

## 7. 家具租賃合約表 (furnitureRentalContracts)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|合約ID|varchar PK|CSV 原欄位「合約編號」|
|2|orderId|訂單ID|varchar FK|CSV 原欄位「對應訂單」|
|3|contractJson|合約 JSON|json|新增|
|4|contractLink|簽章連結|nvarchar(255)|CSV 原欄位「簽章連結」|
|5|deliveryDate|配送日期|date|CSV 原欄位「配送日期」|
|6|terminationPolicy|退租政策|text|CSV 原欄位「退租政策」|
|7|signStatus|簽署狀態|varchar(20)|新增|
|8|signedAt|簽署完成時間|datetime|新增|
|9|eSignatureValue|電子簽章值|nvarchar(255)|CSV 原欄位「電子簽章值」|
|10|createdAt|簽約日期|datetime|CSV 原欄位「簽約日期」|
|11|updatedAt|更新時間|datetime|新增|


## 8. 關聯與約束建議
- `furnitureCarts.memberId` → `members.id`
- `furnitureCartItems.cartId` → `furnitureCarts.id` (ON DELETE CASCADE)
- `furnitureOrders.memberId` → `members.id`
- `furnitureOrders.propertyId` → `properties.id`
- `furnitureOrderItems.orderId` → `furnitureOrders.id` (ON DELETE CASCADE)
- `furnitureOrderItems.productId` → `furnitureProducts.id`
- `furnitureOrderHistory.orderId` → `furnitureOrders.id` (ON DELETE CASCADE)
- `furnitureRentalContracts.orderId` → `furnitureOrders.id` (ON DELETE CASCADE)
- `orderEvents.orderId` → `furnitureOrders.id` (ON DELETE CASCADE)


## 9. 快照表 vs. 一般表使用實例

| 類型 | 目的 | 實例 | 查詢範例 |
|------|------|------|-----------|
|一般表 (交易表)|保存最新業務狀態，可頻繁 UPDATE | `furnitureOrders`, `furnitureOrderItems`, `furnitureInventory` | 取單筆訂單、計算即時庫存 |
|快照表 (歷史表)|鎖定寫入時點資料，不再 UPDATE；供審計、報表 | `furnitureOrderHistory`, `inventoryEvents` (不可變事件) | 查 3 個月前租借紀錄： `SELECT * FROM furnitureOrderHistory WHERE orderId=? AND rentalStart<'2024-01-01'` |

特徵對比：
1. UPDATE 行為：一般表允許更新；快照表僅 INSERT。  
2. 鎖定欄位：快照表保存名稱／價格快照，避免後續資料變動造成歷史失真。  
3. 效能：歷史查詢直接掃快照表，避免多表 JOIN；即時操作仍依賴一般交易表。


# 公告與跑馬燈模組資料（Furniture Marquee & Announcement Module Optimization）

## 1 網站訊息表 (siteMessages／網站訊息表)
| # | 英文欄位 | 中文欄位 | 型別 | 說明 |
|--|-----------|-----------|------|------|
|1|id|訊息ID|int PK|流水號|
|2|title|標題|nvarchar(150)|跑馬燈可 NULL|
|3|content|內文|nvarchar(500)|公告全文／跑馬燈文字|
|4|category|分類|varchar(12)|ANNOUNCEMENT / MARQUEE|
|5|moduleScope|模組|varchar(12)|LANDLORD / TENANT / FURNITURE / COMMON|
|6|messageType|訊息類型|varchar(20)|SYSTEM / PROMOTION …|
|7|displayOrder|顯示順序|int|區段內排序|
|8|startAt|開始時間|datetime2|NULL=立即生效|
|9|endAt|結束時間|datetime2|NULL=永久|
|10|isActive|是否啟用|bit|0/1|
|11|attachmentUrl|圖片/附件URL|nvarchar(255)|可 NULL|
|12|createdAt|建立時間|datetime2|系統填寫|
|13|updatedAt|更新時間|datetime2|系統填寫|
|14|deletedAt|刪除時間|datetime2|軟刪除|

## 2 訊息位置表 (messagePlacements／訊息位置表)
| # | 英文欄位 | 中文欄位 | 型別 | 說明 |
|--|-----------|-----------|------|------|
|1|pageCode|頁面識別碼|varchar PK|對應 pages.pageCode|
|2|sectionCode|區段代碼|varchar PK|HEADER / FOOTER…|
|3|messageId|訊息ID|int FK|對應 siteMessages.id|
|4|subtitle|小標題|nvarchar(100)|區段副標題|
|5|displayOrder|顯示順序|int|區段內排序|
|6|isActive|是否啟用|bit|0/1|
|7|createdAt|建立時間|datetime2|
|8|updatedAt|更新時間|datetime2|


## 3. 關聯與約束建議
- `messagePlacements.messageId` → `siteMessages.id` (ON DELETE CASCADE)
- `messagePlacements.pageCode` → `pages.pageCode` (ON DELETE CASCADE)
- 為 `siteMessages.category`,`moduleScope`,`isActive` 建覆合索引。
- `startAt`,`endAt` 加索引以支援定時上下架查詢。
- CHECK 約束範例：`category='ANNOUNCEMENT' OR title IS NOT NULL`。


## 4. 應用層實作細節

### 4.1 欄位校驗用途
- **目的**：確保資料符合類型需求，避免跑馬燈缺 `content`、公告缺 `title` 等。
- **實作**（NestJS + class-validator 範例）：
```ts
export class CreateMessageDto {
  @IsIn(['ANNOUNCEMENT','MARQUEE'])
  category: string;

  @ValidateIf(o => o.category==='ANNOUNCEMENT')
  @IsNotEmpty({message:'公告需填標題'})
  title?: string;

  @ValidateIf(o => o.category==='MARQUEE')
  @MaxLength(50,{message:'跑馬燈建議 50 字以內'})
  content: string;
}
```
> 亦可於 DB 層以 `CHECK` 約束雙重保險。

### 4.2 跑馬燈文字上色與安全
1. **允許受限 HTML**：僅白名單 `<span style>`，後端使用 **OWASP HTML Sanitizer** 先清洗，再存 DB。
2. **標記語法**：亦可後台 UI 產生 `[color=#F60]8 折[/color]`，前端解析渲染；完全阻斷 HTML，風險更低。
3. 若採統一色，直接在 CSS 控制，無須額外欄位。

### 4.3 公告作跑馬燈顯示示例
1. 後台新增 `category='ANNOUNCEMENT'` 訊息。
2. 在 `messagePlacements` 將該 `messageId` 掛在 `sectionCode='MARQUEE'`。
3. 跑馬燈 API 只撈 `title` 並導向 `/message/{id}`，前端點擊後再載入全文 (`content`)。

### 4.4 擴充彈性評估（Content／Placement／Performance）

| 面向 | 擴充策略 | 說明 |
|------|-----------|------|
|內容面 (Content) | • `category`、`messageType`、`moduleScope` 皆為 ENUM/varchar，可隨時新增值，如 `POPUP`, `EVENT`。<br/>• 若跑馬燈需額外屬性 (scrollSpeed, bgColor) → 以 **子表 marqueeExtras** 垂直擴充，或直接由前端統一樣式。<br/>• 遇到差異極大的新子型 (影片輪播…) → 採 **Table-Per-Type**：在 `siteMessages.id` 上再建對應 1:1 子表。 | 彈性高、不破壞既有結構 |
|位置面 (Placement) | • `messagePlacements` 可多對多，一筆訊息掛多頁面/區段。<br/>• 若需 AB 測試或多語系版位，可再加 `variantCode`／`locale`。<br/>• `pageCode` 預留對 `pages` 表主鍵，後續平台內容管理模組統一管理前端 Router → DB 映對表。 | 易於橫向擴張 |
|效能面 (Performance) | • 常用查詢欄位 `category,moduleScope,isActive,startAt,endAt` 已建覆合索引。<br/>• 若資料量破百萬，可對 `createdAt` 或 `startAt` **水平分區**；或依 moduleScope 分片。<br/>• Read Path 可快取「近期有效跑馬燈」至 Redis；Write Path 使用 Outbox/Event Bus 亦不影響表結構。 | 可隨流量成長調整 |


# 檔案與上傳模組資料（File Uploads & Approval Module Optimization）

## 1. 會員上傳資料紀錄表 (userUploads／會員上傳資料紀錄表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|uploadId|上傳ID|int PK|自動遞增 (新增)|
|2|memberId|會員ID|int FK|members.id|
|3|moduleCode|來源模組代碼|varchar(20) FK|systemCodes.code (codeCategory='SRC_MODULE') (改型)|
|4|sourceEntityId|來源資料ID|int|原 來源ID (改名)|
|5|uploadTypeCode|上傳種類代碼|varchar(20) FK|systemCodes.code|
|6|originalFileName|原始檔名|nvarchar(255)|原始檔案名稱 (擴充)|
|7|storedFileName|實體檔名|varchar(255)|含 UUID，避免衝突 (新增)|
|8|fileExt|副檔名|varchar(10)|原 檔案類別 (改型)|
|9|mimeType|MIME 類型|varchar(100)|由前端或後端推斷 (新增)|
|10|filePath|檔案路徑|varchar(255)|完整 S3/GCS 路徑 (改型)|
|11|fileSize|檔案大小(Byte)|bigint|原 int → bigint (改型)|
|12|checksum|檔案雜湊|varchar(64) NULL|SHA-256，用於秒傳/掃毒 (新增)|
|13|approvalId|審核ID|int FK NULL|fileApprovals.approvalId|
|14|isActive|是否有效|bit|0/1 (新增)|
|15|uploadedAt|上傳時間|datetime2|原 上傳時間 → uploadedAt|
|16|createdAt|建立時間|datetime2|與 uploadedAt 同步 (新增)|
|17|updatedAt|更新時間|datetime2|最後更新 (新增)|
|18|deletedAt|刪除時間|datetime2 NULL|軟刪除 (新增)|


## 2. 檔案審核表 (fileApprovals／檔案審核表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|approvalId|審核ID|int PK|自動遞增 (新增)|
|2|uploadId|上傳ID|int FK|userUploads.uploadId (新增)|
|3|memberId|會員ID|int FK|members.id|
|4|statusCode|審核狀態代碼|varchar(20) FK|systemCodes.code (改型)|
|5|resultDescription|審核說明|nvarchar(500) NULL|原 審核結果說明 (擴充)|
|6|appliedAt|申請時間|datetime2|原 審核申請時間 (改名)|
|7|reviewedAt|審核時間|datetime2 NULL|允許 NULL (改名+允許 NULL)|
|8|reviewerAdminId|審核人員ID|int FK NULL|admins.adminId (改型+允許 NULL)|
|9|createdAt|建立時間|datetime2|新增|
|10|updatedAt|更新時間|datetime2|新增|

## 3. 來源模組代碼分類（整合至 systemCodes）
本系統已決定以 `systemCodes` 管理來源模組清單：
- 在 `systemCodeCategories` 增加 `SRC_MODULE` 分類。
- 於 `systemCodes` 新增各模組代碼，如 `LANDLORD`、`TENANT`、`FURNITURE`…。
- `userUploads.moduleCode`、其他需標示來源模組之表，皆指向 `systemCodes (codeCategory='SRC_MODULE')`。

> 不再建立獨立 `sourceModules` 表。

---

## 4. 關聯與流程建議
1. 使用者上傳檔 → `userUploads` 新增記錄，`approvalId` NULL。
2. 若需人工審核，系統建立 `fileApprovals`，同時回填 `approvalId` 至 `userUploads`。
3. 若 `uploadTypeCode` 或 `moduleCode` 不存在於 `systemCodes` (isActive=1) API 直接拒絕。
4. 審核完成後更新 `fileApprovals.statusCode`，並視結果將 `userUploads.isActive` 改 0/1。

---

## 5. 來源模組改用 systemCodes 之說明
- **需求單純**：僅需辨識「上傳來源」，無需額外欄位（檔案大小上限、路徑等）。
- **統一維護**：與其他下拉代碼同一後台介面，避免多處維護。
- **簡化 Schema**：減少一張表、降低 FK 鎖與 migration 成本。


# 客服與投訴模組資料（Customer Service & Complaints Module Optimization）

## 1. 客服聯繫表 (customerServiceTickets／客服聯繫表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|ticketId|客服單ID|int PK|自動遞增|
|2|memberId|使用者ID|int FK|members.id|
|3|propertyId|房源ID|int FK NULL|properties.id|
|4|contractId|租約ID|int FK NULL|contracts.id / rentalContracts.id|
|5|furnitureOrderId|家具訂單ID|int FK NULL|furnitureOrders.id|
|6|subject|主旨|nvarchar(100)|下拉選單；不可自行輸入|
|7|categoryCode|主分類代碼|varchar(20) FK|systemCodes.code|
|8|content|需求內容|nvarchar(max)|需求內容|
|9|replyContent|客服最後回覆|nvarchar(max) NULL|僅存最新回覆；完整回覆可另建 ticketReplies|
|10|statusCode|狀態代碼|varchar(20) FK|systemCodes.code (Open/InProgress/Closed)|
|11|createdAt|建立時間|datetime2|表單建立時間|
|12|replyAt|最後回覆時間|datetime2 NULL|回覆時間|
|13|updatedAt|更新時間|datetime2|最後更新時間|
|14|handledBy|客服人員ID|int FK NULL|admins.id|
|15|isResolved|是否結案|bit|新增；0/1|

## 2. 房源投訴表 (propertyComplaints／房源投訴表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|complaintId|投訴ID|int PK|自動遞增|
|2|complainantId|投訴人ID|int FK|members.id|
|3|propertyId|房源ID|int FK|properties.id|
|4|landlordId|被投訴房東ID|int FK|members.id|
|5|content|投訴內容|nvarchar(max)|投訴內容|
|6|statusCode|處理狀態代碼|varchar(20) FK|systemCodes.code|
|7|createdAt|投訴時間|datetime2|投訴時間|
|8|updatedAt|更新時間|datetime2|新增|
|9|resolvedAt|結案時間|datetime2 NULL|新增|
|10|internalNote|內部註記|nvarchar(max) NULL|內部註記|
|11|handledBy|處理人員ID|int FK NULL|admins.id|

## 3. 關聯與約束建議
- `customerServiceTickets.memberId`、`propertyComplaints.complainantId` → `members.id` (ON DELETE CASCADE)
- `customerServiceTickets.propertyId`、`propertyComplaints.propertyId` → `properties.id` (ON DELETE SET NULL)
- `customerServiceTickets.contractId` → `contracts.id` (ON DELETE SET NULL)
- `customerServiceTickets.furnitureOrderId` → `furnitureOrders.id` (ON DELETE SET NULL)
- `statusCode`, `categoryCode` 皆對應 `systemCodes.code`，需限制 codeCategory。
- 建議為 `statusCode`, `createdAt`, `memberId` 建立複合索引提升查詢。


# 合約管理模組資料（Contracts Module Optimization）

## 1 contracts 〈合約欄位儲存表〉
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|合約ID|int PK|合約ID|
|2|rentalApplicationId|申請編號ID|int FK|申請編號ID|
|3|templateId|合約範本編號|int FK|合約範本版本|
|4|startDate|合約起始日|date|合約起始日|
|5|endDate|合約結束日|date|合約結束日|
|6|status|合約狀態|varchar(20)|合約狀態 (draft / active / terminated / cancelled)|
|7|courtJurisdiction|管轄法院|nvarchar(50)|管轄法院|
|8|isSublettable|是否可轉租|bit|是否可轉租|
|9|usagePurpose|使用目的|nvarchar(20)|使用目的|
|10|depositAmount|押金金額|int|押金金額|
|11|cleaningFee|清潔費|int|清潔費|
|12|managementFee|管理費|int|管理費|
|13|parkingFee|停車費|int|停車費|
|14|penaltyAmount|違約金金額|int|違約金金額|
|15|createdAt|建立時間|datetime|新增|
|16|updatedAt|更新時間|datetime|新增|

## 2 contractFurnitureItems 〈合約內容家具表〉
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|家具清單ID|int PK|家具清單編號ID|
|2|contractId|合約ID|int FK|合約ID|
|3|furnitureName|家具名稱|nvarchar(50)|家具名稱|
|4|furnitureCondition|家具狀況|nvarchar(30)|家具狀況|
|5|quantity|數量|int|數量|
|6|repairChargeOwner|修繕費負責人|nvarchar(20)|修繕費負責人 (代碼)|
|7|repairResponsibility|維修權責|nvarchar(20)|維修權責 (代碼)|
|8|unitPrice|單價|int|新增|
|9|amount|小計|int|新增 (unitPrice × quantity)|

## 3 contractComments 〈合約備註表〉
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|合約備註ID|int PK|合約備註ID|
|2|contractId|合約ID|int FK|合約ID|
|3|commentType|備註類型|varchar(20)|新增 (system/user)|
|4|commentText|內容|nvarchar(100)|內容|
|5|createdById|建立者|int FK|新增|
|6|createdAt|建立時間|datetime|新增|

## 4 contractSignatures 〈電子簽名儲存表〉
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|電子簽名ID|int PK|電子簽名ID|
|2|contractId|合約ID|int FK|合約ID|
|3|signerId|簽約人MemberID|int FK|簽約人MemberID|
|4|signerRole|簽署人身分|varchar(20)|簽署人身分 (tenant/landlord/platform)|
|5|signMethod|簽名方式|nvarchar(20)|簽名方式|
|6|signatureFileUrl|簽名檔URL|nvarchar(255)|新增|
|7|signVerifyInfo|簽署驗證資訊|nvarchar(255)|簽署驗證資訊|
|8|signedAt|時間戳|datetime|時間戳|

## 5 contractCustomFields 〈合約附表(動態欄位)〉
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|動態欄位ID|int PK|動態欄位ID|
|2|contractId|合約ID|int FK|合約ID|
|3|fieldKey|動態欄位名稱|nvarchar(30)|動態欄位名稱|
|4|fieldValue|動態欄位值|nvarchar(100)|動態欄位值|
|5|fieldType|動態欄位型態|varchar(20)|動態欄位型態 (text/number/date/enum)|
|6|displayOrder|顯示順序|int|新增|

## 6 contractTemplates 〈合約範本表〉
| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|id|範本編號|int PK|範本編號|
|2|templateName|範本名稱|nvarchar(30)|範本名稱|
|3|templateContent|範本內容|nvarchar(max)|範本內容|
|4|uploadedAt|範本上傳時間|datetime2|範本上傳時間|

---

## 5. 關聯與約束建議
- `contracts.templateId` → `contractTemplates.id` (ON DELETE RESTRICT)
- `contracts.rentalApplicationId` → `rentalApplications.id` (ON DELETE SET NULL)
- 子表 `contractFurnitureItems`、`contractComments`、`contractSignatures`、`contractCustomFields` 之 `contractId` 均設 `ON DELETE CASCADE`。
- `contracts.status` 加 CHECK 約束（draft, active, terminated, cancelled）。
- 為高頻查詢欄位建立索引：`contractId`, `status`, `startDate`, `endDate`。


---

# 代碼與地理模組資料（Codes & Geography Module Optimization）

## 1. 縣市代碼表 (cities／縣市代碼表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|cityCode|縣市代碼|varchar(10) PK|原 縣市代碼 (改型)|
|2|cityName|縣市名稱|nvarchar(50)|原 縣市描述 (改名+擴充)|
|3|displayOrder|排序|int|前端顯示順序 (新增)|
|4|isActive|是否啟用|bit|0/1 (新增)|
|5|createdAt|建立時間|datetime2|新增|
|6|updatedAt|更新時間|datetime2|新增|

## 2. 鄉鎮區代碼表 (districts／鄉鎮區代碼表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|districtCode|區代碼|varchar(10) PK|原 鄉鎮區代碼 (改型)|
|2|districtName|區名稱|nvarchar(50)|原 鄉鎮區描述 (改名+擴充)|
|3|cityCode|縣市代碼|varchar(10) FK|cities.cityCode (改型)|
|4|zipCode|郵遞區號|varchar(5)|新增|
|5|isActive|是否啟用|bit|0/1 (新增)|
|6|createdAt|建立時間|datetime2|新增|
|7|updatedAt|更新時間|datetime2|新增|

## 3. 代碼類別表 (systemCodeCategories／代碼類別表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|codeCategory|代碼類別|varchar(20) PK|原 代碼類別ID (改型+改名)|
|2|categoryName|類別名稱|nvarchar(50)|原 代碼類別名稱 (改名+擴充)|
|3|description|描述|nvarchar(100) NULL|新增|
|4|isActive|是否啟用|bit|0/1 (新增)|
|5|createdAt|建立時間|datetime2|新增|
|6|updatedAt|更新時間|datetime2|新增|

## 4. 代碼總表 (systemCodes／代碼總表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|codeCategory|代碼類別|varchar(20) FK PK|systemCodeCategories.codeCategory (改型)|
|2|code|代碼|varchar(20) PK|原 代碼值 (改名)|
|3|codeName|代碼名稱|nvarchar(50)|原 描述 (改名+擴充)|
|4|displayOrder|排序|int|新增|
|5|isActive|是否啟用|bit|0/1 (新增)|
|6|createdAt|建立時間|datetime2|新增|
|7|updatedAt|更新時間|datetime2|新增|

## 5. 關聯與索引建議
- `districts.cityCode` → `cities.cityCode` (ON DELETE RESTRICT)
- `systemCodes.codeCategory` → `systemCodeCategories.codeCategory`
- `systemCodes` 建立複合索引 (codeCategory, displayOrder)。
- 為 `isActive` 與 `displayOrder` 建索引支援前端查詢排序。

---

## 6.1 欄位整合應用實例
以下示範如何在 **systemCodeCategories** 與 **systemCodes** 兩表中，同時利用所有欄位完成「通知類型（NOTI_TYPE）」分類與代碼維護。

### （1）systemCodeCategories 範例資料
| codeCategory | categoryName | description | isActive | createdAt | updatedAt |
|--------------|-------------|-------------|----------|-----------|-----------|
| NOTI_TYPE | 通知類型 | 前端所有通知的分類 | 1 | 2024-01-01 00:00 | 2024-01-01 00:00 |

> • codeCategory：主鍵，程式中固定使用 `NOTI_TYPE` 辨識。  
> • categoryName：後台顯示「通知類型」。  
> • description：補充用途說明，方便營運人員閱讀。  
> • isActive：若要暫時停用整個分類，可改為 0。  
> • createdAt / updatedAt：稽核時間戳。

### （2）systemCodes 範例資料
| codeCategory | code | codeName | displayOrder | isActive | createdAt | updatedAt |
|--------------|------|---------|--------------|----------|-----------|-----------|
| NOTI_TYPE | SYS | 系統通知 | 1 | 1 | 2024-01-01 00:00 | 2024-01-01 00:00 |
| NOTI_TYPE | MSG | 站內私訊 | 2 | 1 | 2024-01-01 00:00 | 2024-01-01 00:00 |
| NOTI_TYPE | PROMO | 行銷推播 | 3 | 0 | 2024-01-01 00:00 | 2024-05-01 12:00 |

> • code：在程式邏輯與 API 參數中傳遞的值，例如 `SYS`。  
> • codeName：前端下拉清單顯示文字。  
> • displayOrder：控制前端排序順序。  
> • isActive：`PROMO` 已設為 0，代表前端不再顯示但仍保留歷史。  
> • createdAt / updatedAt：方便稽核與快取失效。

### （3）整合使用流程
1. 後台管理者於「代碼維護」頁→`systemCodeCategories` 建立/編輯分類。  
2. 於同頁檢視該分類下所有 `systemCodes`，可調整排序、啟用狀態或多語詞條。  
3. 前端載入下拉選單時：
   - SQL：`SELECT code, codeName FROM systemCodes WHERE codeCategory = 'NOTI_TYPE' AND isActive = 1 ORDER BY displayOrder;`  
   - 取得 `SYS / 系統通知`、`MSG / 站內私訊`。  
4. 若將 `PROMO` isActive 改回 1，即可瞬間釋出行銷推播類型，無須改動程式碼。


# 管理員與權限模組資料（Admin & Permission Module Optimization）

## 1. 管理員資料表 (admins／管理員資料表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|adminId|管理員ID|int PK|自動遞增 (新增)|
|2|account|帳號|varchar(50) UNIQUE|原 ID+帳號 → account；拆出主鍵|
|3|passwordHash|密碼雜湊|nvarchar(255)|原 密碼 → bcrypt/argon2 雜湊 (改名+擴充)|
|4|passwordSalt|密碼 Salt|nvarchar(64) NULL|若演算法需|
|5|name|姓名|nvarchar(50)|原 姓名 (長度擴充)|
|6|roleCode|角色代碼|varchar(20) FK|adminRoles.roleCode (改型)|
|7|isActive|是否啟用|bit|0/1 (新增)|
|8|lastLoginAt|最後登入時間|datetime2 NULL|登入成功時更新 (新增)|
|9|passwordUpdatedAt|密碼更新時間|datetime2 NULL|定期強制更換 (新增)|
|10|createdAt|建立時間|datetime2|帳號建立 (新增)|
|11|updatedAt|更新時間|datetime2|最後變更 (新增)|
|12|deletedAt|刪除時間|datetime2 NULL|軟刪除 (新增)|

## 2. 管理員角色資料表 (adminRoles／管理員角色資料表)

| # | 英文欄位 | 中文欄位 | 型別 | 來源/說明 |
|---|-----------|-----------|------|-----------|
|1|roleCode|角色代碼|varchar(20) PK|原 身份別代碼 (改型)|
|2|roleName|角色名稱|nvarchar(50)|原 身份別名稱 (長度擴充)|
|3|permissionsJson|權限JSON|nvarchar(max)|原 權限JSON (改型)|
|4|isActive|是否啟用|bit|0/1 (新增)|
|5|createdAt|建立時間|datetime2|新增|
|6|updatedAt|更新時間|datetime2|新增|

## 3. 關聯與安全約束建議
- `admins.roleCode` → `adminRoles.roleCode` (ON DELETE RESTRICT)。
- `account` UNIQUE INDEX；`passwordHash` 長度 60 以上。
- 建議對 `lastLoginAt`,`createdAt` 建索引以利稽核。
- 權限建議採 RBAC + 權限細項 JSON，以 API 驗證時解析。

# 聊天室模組

## 1. 聊天室表 (chatrooms)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 舊欄位來源／說明 |
|---|---|---|---|---|
| 1 | chatroomID | 聊天室ID | int (PK, IDENTITY) | 原 聊天室編號ID |
| 2 | initiatorMemberID | 發起人MemberID | int | 原 發起人ID (FK) |
| 3 | participantMemberID | 參與者MemberID | int | 原 參與者ID (FK) |
| 4 | propertyID | 房源ID | int | 原 房源ID (FK, Nullable) |
| 5 | createdAt | 建立時間 | datetime2(7) | 原 建立時間 |
| 6 | lastMessageAt | 最後訊息時間 | datetime2(7) | **新增**，加速排序 |
| 7 | updatedAt | 更新時間 | datetime2(7) | **新增** 行為追蹤 |


## 2. 聊天室訊息表 (chatroomMessages)

| # | 新欄位 (英文) | 新欄位 (中文) | 資料型別 | 舊欄位來源／說明 |
|---|---|---|---|---|
| 1 | messageID | 訊息ID | int (PK, IDENTITY) | 原 訊息編號ID |
| 2 | chatroomID | 聊天室ID | int | 原 聊天室編號ID (FK) |
| 3 | senderMemberID | 發送者MemberID | int | 原 發送者ID (FK) |
| 4 | content | 內容 | nvarchar(1000) | 原 內容 |
| 5 | isRead | 是否已讀 | bit | 原 是否已讀 |
| 6 | sentAt | 傳送時間 | datetime2(7) | 原 傳送時間 |
| 7 | readAt | 已讀時間 | datetime2(7) | **新增**，Nullable |

### 2.4 移除／合併欄位
- **無移除**，僅欄位更名與欄位補充。

---

## 3. 關聯與約束
- `chatrooms.initiatorMemberID`、`chatrooms.participantMemberID` → `members.memberID`
- `chatrooms.propertyID` → `properties.propertyID`
- `chatroomMessages.chatroomID` → `chatrooms.chatroomID`
- `chatroomMessages.senderMemberID` → `members.memberID`

額外索引建議：
1. `chatrooms (initiatorMemberID, participantMemberID)` – 避免建立重複聊天室。
2. `chatroomMessages (chatroomID, sentAt DESC)` – 快速撈取最新訊息。
3. `chatroomMessages (senderMemberID, isRead)` – 計算未讀訊息。

---

## 4. 性能與資料一致性
- 所有布林欄位統一 `CHECK (isRead IN (0,1))`。
- 建議在 `chatrooms.lastMessageAt` 上維護 TRIGGER，於 `chatroomMessages` 新增後自動更新。
- 對 `content` 加 `CHECK (LEN(content) > 0)` 避免空訊息。
