# 頁面名稱與功能概述
- 頁面名稱：刊登房源頁面（Landlord → Create Listing）
- 頁面目標：房東填寫房源資訊並送出審核，資料儲存於資料庫並進入待審核狀態

# 新增技術
- 使用 ImageSharp 儲存圖片並轉換為 .webp
- 可結合 LazyLoad + WebP
- 不保存原始圖片（但為了預覽，前端須保留原圖，送出表單後再由伺服端處理）

# 注意事項
- members.isLandlord == 0 && members.memberTypes == 1，禁止開啟此頁面（需驗證身份通過）
- 若未上傳封面圖，不能送出
- 勿接受純前端驗證，後端需重複驗證資料正確性，例如：房源名稱與地址組合需全庫唯一 → 後端重複檢查
- **房源圖上傳限制：**每筆房源最多 15 張，可批量上傳，每張圖最大限制 2MB，支援 .jpg/.jpeg、.png
- 須測試確保圖片儲存為 WebP 且路徑正確
- 避免 Mock 或假資料，使用真實 SQL Server（連線字串從 appsettings.json）
- 確保外鍵約束）
- 避免過度設計
- **安全性：**確保所有數據傳輸加密，防止 SQL 注入、XSS 等攻擊。圖片上傳必須驗證檔案類型，防止惡意文件上傳
- **效能：**大量圖片上傳時，應有進度回饋，避免頁面卡頓
- **錯誤處理：**API 錯誤應友善地通知使用者，並提供解決方案
- 國際化/在地化： (如果未來有此需求，可提前考慮文字的可擴展性)

# 相關連動的頁面
### 我負責的頁面
- `Views/Property/Detail.cshtml`房源詳細資訊頁面 (租客端)： 房源發佈後，租客應能在此頁面查看該房源的所有資訊
- （尚未製作）房源管理頁：刊登成功後，應能在此頁面看到新增的房源
- （尚未製作）房東的個人資料檢視頁面：包含房東的個人資料，以及目前上架中的房源

### 非我負責，但未來需要提供 / 串連 api 的頁面
- 登入/註冊頁面： 用戶必須先登入才能存取刊登房源頁面
- 房源審核後台：後台管理員可以操作、確認
- 個人資料頁面：房東的相關資料預設從這裡獲取

# 頁面內容
## 表單欄位：
### 「房屋資訊」區塊(表單標題)
- 房源標題：文字輸入，必填，最多輸入 30 字，資料表：properties.title
- 租金：數字輸入，必填，單位：元/月，資料表：properties.monthlyRent
- 地址：分兩個下拉選單(1) 市 、(2) 區，詳細地址為文字輸入，必填
  - 市資料表：關聯 citie.cityId，前端顯示 citie.cityName，須判斷 citie.isActive == 1，若為 0 則不顯示在下拉選單中
  - 區資料表：關聯 districts.districtId，前端顯示 districts.districtName，，須判斷 districts.isActive == 1，若為 0 則不顯示在下拉選單中；同時 districts.districtId 關聯 citie.cityId，先讀取到 citie.cityId，才能顯示關聯 citie.cityId 的 districts.districtId
  - 詳細地址資料表：properties.addressLine
- 格局：() 房 () 廳 () 衛，必填，() 為輸入欄位
  - 房數資料表：properties.roomCount
  - 衛數資料表：properties.bathroomCount
  - 廳數資料表：properties.livingRoomCount
  - 
- 坪數：() 坪，必填，資料表：properties.area
- 樓層：() 樓 () 層，必填
  - 樓資料表：properties.currentFloor
  - 層資料表：properties.totalFloors
- 房屋圖片上傳：檔案輸入，支援多張 JPG/PNG，最大 5MB/張，須添加說明提示，必填，資料表：propertyImages.imagePath
- 房屋證明文件：檔案輸入，支援多種類型 JPG/PNG/PDF，最多上傳 3 份，必填，資料表：properties.propertyProofURL
### 「費用及守則」區塊(表單標題)
- 押金金額：共房租 () 月，金額 () 元，必填
    - 押金金額資料表：properties.depositAmount
    - 押金月數資料表：properties.depositMonths
- 最短租期：下拉選單，可選 6 個月、一年、兩年，必選，資料表：properties.minimumRentalMonths，由程式碼寫入月數，只可輸入 6、12、24
- 管理費：兩個單選框 (1) 包含在租金中、(2) 須另計，必填
  - 選擇「包含在租金中」，不顯示文字輸入欄位
  - 選擇「須另計」，顯示文字輸入欄位 () 元/月，文字輸入欄位必填
    - 管理費金額的資料表：properties.managementFeeAmount
    - 管理費是否含租金的資料表：properties.managementFeeIncluded，0 為否，1 為是
- 水電費計算：分為兩個分類 (1) 水費、(2) 電費，皆為必選，分類純文字非選項
  - 水費：兩個單選框 (1) 台水、(2) 自訂金額 () 元/月，選擇自訂金額，文字欄位為必填
    - 水費計算方式資料表：properties.waterFeeType，由程式寫入，分為台水、自訂金額
    - 自訂水費的金額資料表：properties.customWaterFee
  - 電費：兩個單選框 (1) 台電、(2) 自訂金額 () 元/每度，選擇自訂金額，文字欄位為必填
    - 電費計算方式資料表：properties.electricityFeeType，由程式寫入，分為台電、自訂金額
    - 電費自訂的金額資料表：properties.customElectricityFee
- 守則：預設顯示一個文字輸入欄位，附帶「+」按鈕新增，最多新增三個，可選，最多輸入 20 字，資料表：properties.specialRules
- 是否須清潔費：兩個單選框 (1) 是、() 否，必填
  - 是否須清潔費的資料表：properties.cleaningFeeRequired
  - 當 properties.cleaningFeeRequired == 1，清潔費金額資料表：properties.cleaningFeeAmount
  - 是否有停車位：兩個單選框(1) 沒有、(2) 有及一個勾選框 - 須額外收費
    - 勾選框與單選框不連動，單選框為必填，預設為沒有；勾選框為可選
    - 勾選框若勾選，顯示輸入金額欄位 () 元/月，必填
    - 是否有停車位的資料表：properties.parkingAvailable
    - 停車費的資料表：properties.parkingFeeAmount
    - 停車費須額外收費的資料表：properties.parkingFeeRequired，若使用者無勾選則自動寫入 0

### 「設備與服務」區塊(表單標題)
- 大分類：首先讀取 propertyEquipmentCategories.parentCategoryID == null 當作大分類，接著再依照propertyEquipmentCategories.categoryID 順序顯示 propertyEquipmentCategories.categoryName
- 子項：使用 propertyEquipmentCategories.parentCategoryID == categoryID，判斷屬於哪個子分類，再逐一歸類在每個大分類下，顯示 categoryName
- 皆為勾選框，皆非必選
- 若子項下還有其他類別，則跟在對應子項後方，例如：() 可養寵 - () 貓、() 狗、() 其他小型寵物，若勾選可養寵，則跟在該子項後的細項則必須選一樣
- 須判斷 propertyEquipmentCategories.isActive == 1，為 1 顯示，為 0 則隱藏

### 「描述」區塊(表單標題)
- 描述：文字區域，可選，資料表：properties.description

### 設定刊登天數
- 選擇刊登方案：單選框，讀取 listingPlans.planName
- 顯示下架日紅字提示：依照選擇的天數自動計算到期日，例如：在 2025-07-15 選擇刊登天數 3 天，則下架日：2025-07-19 的 00:00 下架，文字提示格式：您選擇的方案刊登日為(粗體) 3 天(粗體)，預計下架日 2025-07-19 00:00（24 小時制）
  - 下架日計算：系統讀取使用者設備日期 + 刊登方案天數 + 1 天的 00:00
  - 發佈後程式依照 listingPlans.minListingDays 寫入 properties.listingDays
  - properties.listingFeeAmount 使用 listingPlans.pricePerDay * listingPlans.minListingDays 後的數值，欄位最終不能含算法，避免資料表的方案修改金額或天數後，造成資料與刊登時不符
- 刊登費用總計：費用總計共 (粗體) NT$ 金額(粗體) 元
  - 須千分位符號，例如 NT$ 1,000
  - 資料表 properties.expireAt 依照 properties.paidAt + properties.listingDays 天數計算填入，故刊登後不需先寫入，須判斷 properties.statusCode == LISTED 才進行寫入

### 按鈕：
- 預覽、立即發佈、取消發佈
  - 點選「取消發佈」：須提示「是否確定取消發佈？」→ 左-確定取消( #313b48)、右-繼續編輯( #1a7482)
- 點選「預覽」：即時跳出內嵌彈窗頁，預覽將呈現的畫面
- 點選「立即發佈」：彈窗提醒，佈局：
  - 房源審核提醒(置中標題)
  - 在標題下的置中小字(深灰色)：您的房源資料已提交成功！房源將進入後台審核流程，我們會仔細檢查以下項目：
  - 房產證明文件的完整性
  - 房源照片品質與真實性
  - 房源資訊的準確性
  - 一個框選的區塊：審核時間(小標題)、換行小字：通常需要 1 至 3 個工作天，審核通過後將通知您付款，敬請留意，付款成功後系統將立即上架！
  - 按鈕：返回編輯（框線  #66c0a4）、確認提交（ #e95d54）

# 使用者體驗與流程
## UI 說明
### 佈局：
- 固定頂部導覽列
- 下方固定次導航條，包含進度指示
### 內容區域：
- 主內容：Bootstrap container，左右 padding 15px
  - 桌面版 (大於 768px)： 採用兩欄或三欄布局。左側為主要表單內容區（或圖片區），右側為側邊欄（步驟導航或概要訊息）
  - 行動版 (小於 768px)： 內容區域堆疊布局，所有元素垂直排列
- 按鈕：底部右對齊，間距 10px，包含預覽、立即發佈、取消發佈按鈕
### 具體元件與樣式：
- 表單元素： 統一使用 Bootstrap 5.3 的表單控件（form-control, form-select, form-check 等），確保一致性，且不使用過多的圓角，最多 5px
- 圖片上傳區：
  - 一個帶有虛線邊框和「拖曳圖片至此或點擊上傳」提示文字的區域。
  - 上傳後，顯示圖片縮圖網格，每張縮圖上應有「設定為主圖」圖標（例如星星）、移動排序的手柄（例如十字箭頭或三條槓）和「刪除」圖標（例如垃圾桶）
  - 可輸入圖片名稱的欄位（供房源詳細資訊頁面檢視）
- 側邊欄 (步驟導航)：
  - 在桌面版應清晰顯示各步驟名稱，凸顯當前步驟。
  - 點擊步驟名稱可平滑跳轉到對應的表單區塊，進度條應清晰可見。
- 按鈕：Bootstrap btn，自定義顏色（預覽： #1a7482，立即發布：(尚未完成填寫) #f9cfc7，(完成填寫) #e95d54，取消： #66c0a4 框線），填滿顏色的按鈕字體皆為 #FFFFFF。
- 整體風格：要美觀、清潔、現代、直觀，遵循 Bootstrap 5.3 的設計原則
- 錯誤訊息：紅色文字（text-danger），顯示於欄位下方
- 預覽區圖片：縮圖 100x100px，主圖 300x200px

## UX 說明
### 互動流程：
- 房東輸入表單欄位，預覽區即時更新（例如，輸入標題後預覽區同步顯示）。
- 圖片上傳後，立即在預覽區顯示縮圖，支援拖放上傳。
- 點擊「儲存草稿」或「立即發布」，顯示載入動畫，成功後跳轉至房東儀表板。
- 點擊「取消」，提示確認後返回上一頁。
- 欄位驗證失敗時，顯示清晰錯誤訊息（例如「標題不能為空」）。
### 用戶引導：
- 必填欄位標記星號（*），提供 placeholder 提示（例如「輸入房源標題」）。
- 圖片上傳區域顯示「拖放或點擊上傳」提示。
- 按鈕禁用直到必填欄位完成（JavaScript 控制）。
### 流暢性：
- 表單輸入使用防抖動（debounce）減少即時預覽的性能開銷。
- 圖片上傳支援進度條（若檔案較大）。
- 響應式切換無閃爍，確保手機操作順暢。

# 頁面邏輯及驗證
- 使用 FluentValidation 驗證必填欄位、規格是否都已符合標準。
- 每個步驟的表單提交時，進行前端驗證。
- 後端 API 接收資料時，進行嚴格的後端驗證。
- 清晰的錯誤提示信息，引導用戶修正。
- 數據暫存：
  - 用戶在不同步驟間切換時，已填寫的數據應能被暫存（例如，在前端狀態管理或本地儲存中）。
-   如果用戶中途離開頁面，再次進入時應能恢復到上次編輯的步驟和已填寫的資料（瀏覽器暫存）。
- 圖片上傳邏輯：支援多圖上傳，上傳成功後，即時顯示縮圖預覽，支援拖曳排序、設定主圖、刪除圖片。
- 後端負責圖片儲存、縮圖生成、資料庫圖片路徑更新。
- 發佈： 所有必填資訊完成並驗證通過後，點擊「發佈」按鈕，並更新房源狀態為「審核中」
  - 使用程式碼寫入，properties.statusCode
  - 總狀態碼如下：
    - PENDING / 審核中
    - REJECT_REVISE / 審核未通過(待補件)
    - PENDING_PAYMENT / 待付款
    - LISTED / 上架中：付款完成直接進入
    - UNLISTED / 已下架
    - RENTED / 已出租
    - CONTRACT_ISSUED / 已發出合約 - 房東可自行撤回
    - PENDING_RENEWAL / 待續約 - 當租約到期，房東未處理，會自動回到待付款
    - LEASE_EXPIRED_RENEWING / 合約到期（房客續約） - 房客申請中
    - LEASE_EXPIRED_NO_RENEWAL / 合約到期（房客不續約） - 房東付款
    - 除了「審核中」的狀態，該頁面會使用到之外，其他頁面都將在（待開發）的房源管理頁面，可暫先處理寫入 PENDING
- 守則等用戶輸入欄位可使用 JSON 存取，其他為我方提供選擇的多選項則使用 Enum 方式存取

# 非本頁使用但仍然重要的關聯資料欄位
isPaid：判斷 paidAt 已寫入，才能轉為 1，否則預設為 0

# 其他由系統自動寫入的欄位
- propertyID：房源發佈後產生
- landlordMemberID：讀取 members.memberID
- listingPlanID：依照使用者選擇的方案連動
- previewImageURL：依照使用者上傳後的圖片產生的縮圖連結
- publishedAt：寫入 paidAt 的日期，須判斷 isPaid == 1，若為 0 則不可寫入
- updatedAt：自動寫入發佈日，若後續有編輯再儲存則可覆蓋


# 希望達成的結果：
- 使用者友好： 房東能直觀、順暢地完成房源刊登
- 數據完整性： 確保所有必要資訊都被準確收集和保存
- 穩定性： API 和資料庫操作穩定可靠，圖片上傳和處理無誤
- 可擴展性： 頁面和後端邏輯應易於未來新增字段或步驟
- 表單驗證正確，錯誤訊息清晰
- 預覽區即時反映輸入，響應式佈局在手機/平板/桌面正常顯示
- API 可透過 Swagger UI 測試，單元測試通過 

依照上述的詳細規劃，逐步開發「刊登房源頁面」及其後端 API。將此複雜功能分解為更小的、可管理的任務，並會遵循「一次建立/重構一個函數/類別」的模組化開發方式。

當需要 AI 協助時，提供每次任務所需的具體上下文、目標、輸入輸出、職責和技術約束，確保產出的程式碼能與我的整體架構無縫整合。

例如，首先開發 PropertyService.CreatePropertyBasicInfoAsync 方法，完成之後 push 成果(一個小組件完成)，才繼續進行圖片上傳 API 的核心方法 ImageService.UploadPropertyImageAsync，在完成之後才接著是表單的 UI 組件等等。

# 請你（Claude）依照計劃產生一個具體的原子化工作注意事項，在執行前都需要傳給我確認，以下是範例：
---
### 【專案上下文】
- **專案名稱/功能模組：** (例如：房源管理系統 / 用戶身份驗證模組)
- **相關檔案/區塊：** (這個函數/類別將被放在哪個檔案或哪個主要類別中)
- **核心目標：** (這個部分在專案中的高層次目標是什麼)

---
### 【本次任務目標：建立/重構(函數/類別/元件)：(明確的名稱)**
- **任務類型：** (例如：建立一個新的公共方法 / 重構現有的私有函數 / 定義一個新的資料模型類別)
- **單一職責：** 詳細描述這個函數/類別的唯一職責是什麼，它應該做且只做什麼)
- **輸入 (Parameters/Properties)：** (例如：接收 `(int propertyId, string userId)` / 包含 `string Name, int Age` 屬性)
- **輸出 (Return Type/Result)：** (例如：返回 `Task<bool>` 表示操作是否成功 / 產生一個 `PropertyDetailViewModel` 物件)
- **預期行為/邏輯：** (具體描述其內部邏輯步驟，例如：驗證輸入、查詢資料庫、執行計算、更新狀態、拋出特定錯誤)
- **錯誤處理：** (預期會遇到哪些錯誤情況，以及如何處理它們（例如：拋出異常、返回特定的錯誤對象、記錄日誌）)

---
### 【技術規格與約束】
- **程式語言：** (例如：C# 8 / JavaScript ES6+)
- **框架/庫：** (例如：ASP.NET Core MVC / Entity Framework Core / Bootstrap 5.3 / Vanilla JS)
- **特定模式/規範：** (例如：使用異步操作 `async/await` / 遵循 Repository Pattern / 嚴格的模型驗證)
- **避免事項：** (例如：不要直接執行 SQL 查詢 / 不要包含 UI 邏輯 / 不要依賴外部 Mocking 框架)

---
### 【範例用法 / 測試建議】
- **如何呼叫/實例化：** (提供一行或兩行程式碼，展示如何在專案其他地方使用這個函數/類別)
- **測試驗證點：** (建議幾個關鍵的測試情境，以驗證其功能是否正確)

---